<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>iOS Dark Gym + Running Planner</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700;800;900&display=swap');

    body {
      margin: 0;
      background: #000000;
      font-family: 'SF Pro Display', system-ui, -apple-system, BlinkMacSystemFont;
      color: #FFFFFF;
    }

    .glass-nav {
      backdrop-filter: blur(20px);
      background: rgba(20, 20, 20, 0.85);
    }

    .soft-border {
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .soft-glow {
      box-shadow: 0 0 18px rgba(255, 255, 255, 0.18);
    }

    .modal-slide {
      animation: slideUp 0.25s ease-out;
    }

    @keyframes slideUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .sticky-month {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #000000;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const WEEK_DAYS = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

    function startOfWeek(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = (day === 0 ? -6 : 1 - day);
      d.setDate(d.getDate() + diff);
      d.setHours(0,0,0,0);
      return d;
    }

    function addDays(date, n) {
      const d = new Date(date);
      d.setDate(d.getDate() + n);
      return d;
    }

    function App() {
      const [tab, setTab] = useState("home");
      const [routines, setRoutines] = useState(() => {
        const saved = localStorage.getItem("routines_v3");
        return saved ? JSON.parse(saved) : {};
      });

      const [runningSessions, setRunningSessions] = useState(() => {
        const saved = localStorage.getItem("running_v1");
        return saved ? JSON.parse(saved) : {};
      });

      const [creating, setCreating] = useState(false);
      const [routineType, setRoutineType] = useState("gym");
      const [routineName, setRoutineName] = useState("");
      const [selectedDays, setSelectedDays] = useState([]);
      const [activeDayTab, setActiveDayTab] = useState(null);
      const [dayWorkouts, setDayWorkouts] = useState({});
      const [showModal, setShowModal] = useState(false);
      const [exerciseForm, setExerciseForm] = useState({
        name: "",
        sets: "",
        reps: "",
        weight: ""
      });

      const [runDistance, setRunDistance] = useState("");
      const [runPace, setRunPace] = useState("");
      const [runNotes, setRunNotes] = useState("");
      const [selectedCalendarDate, setSelectedCalendarDate] = useState(null);
      const [dayRoutines, setDayRoutines] = useState([]);
      const [dayRun, setDayRun] = useState(null);
      const [workoutRoutine, setWorkoutRoutine] = useState(null);
      const [runSession, setRunSession] = useState(null);
      const [timer, setTimer] = useState(0);
      const [running, setRunning] = useState(false);
      const [weeks, setWeeks] = useState([]);
      const calendarRef = useRef(null);
      const [weekStart, setWeekStart] = useState(() => startOfWeek(new Date()));
      const [expandedWeekday, setExpandedWeekday] = useState(null);
      const [previewRoutine, setPreviewRoutine] = useState(null);
      const [previewDay, setPreviewDay] = useState(null);
      const [previewRun, setPreviewRun] = useState(null);

      const today = new Date();

      useEffect(() => {
        localStorage.setItem("routines_v3", JSON.stringify(routines));
      }, [routines]);

      useEffect(() => {
        localStorage.setItem("running_v1", JSON.stringify(runningSessions));
      }, [runningSessions]);

      useEffect(() => {
        let interval;
        if (running) {
          interval = setInterval(() => {
            setTimer(t => t + 1);
          }, 1000);
        }
        return () => clearInterval(interval);
      }, [running]);

      useEffect(() => {
        const initial = [];
        for (let i = -2; i <= 12; i++) {
          initial.push(addDays(startOfWeek(new Date()), i * 7));
        }
        setWeeks(initial);
      }, []);

      const formatTime = (seconds) => {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      };

      const startCreateRoutine = () => {
        setCreating(true);
        setRoutineName("");
        setSelectedDays([]);
        setActiveDayTab(null);
        setDayWorkouts({});
        setRunDistance("");
        setRunPace("");
        setRunNotes("");
      };

      const toggleDaySelection = (day) => {
        setSelectedDays(prev => {
          if (prev.includes(day)) {
            return prev.filter(d => d !== day);
          } else {
            return [...prev, day];
          }
        });
      };

      const openAddExerciseModal = () => {
        setShowModal(true);
        setExerciseForm({ name: "", sets: "", reps: "", weight: "" });
      };

      const addExerciseToDay = () => {
        if (!activeDayTab || !exerciseForm.name) return;
        const newEx = {
          name: exerciseForm.name,
          sets: exerciseForm.sets || "3",
          reps: exerciseForm.reps || "10",
          weight: exerciseForm.weight || ""
        };
        setDayWorkouts(prev => ({
          ...prev,
          [activeDayTab]: [...(prev[activeDayTab] || []), newEx]
        }));
        setShowModal(false);
      };

      const saveRoutine = () => {
        if (!routineName.trim()) {
          alert("Please enter a name");
          return;
        }
        if (selectedDays.length === 0) {
          alert("Please select at least one day");
          return;
        }

        if (routineType === "gym") {
          const newRoutine = {
            name: routineName,
            days: selectedDays,
            workouts: dayWorkouts
          };
          setRoutines(prev => ({ ...prev, [routineName]: newRoutine }));
        } else {
          const runData = {
            name: routineName,
            distance: runDistance,
            pace: runPace,
            notes: runNotes
          };
          const updated = { ...runningSessions };
          selectedDays.forEach(day => {
            updated[day] = runData;
          });
          setRunningSessions(updated);
        }

        setCreating(false);
      };

      const deleteRoutine = (name) => {
        const updated = { ...routines };
        delete updated[name];
        setRoutines(updated);
      };

      const deleteRunForDay = (day) => {
        const updated = { ...runningSessions };
        delete updated[day];
        setRunningSessions(updated);
      };

      const getRoutinesForWeekday = (weekday) => {
        return Object.values(routines).filter(r => r.days && r.days.includes(weekday));
      };

      const getRunForWeekday = (weekday) => {
        return runningSessions[weekday] || null;
      };

      const hasGymOnWeekday = (weekday) => {
        return getRoutinesForWeekday(weekday).length > 0;
      };

      const startWorkoutFromPreview = () => {
        if (!previewRoutine || !previewDay) return;
        const exercises = (previewRoutine.workouts && previewRoutine.workouts[previewDay]) || [];
        setWorkoutRoutine({
          name: previewRoutine.name,
          day: previewDay,
          exercises
        });
        setTimer(0);
        setRunning(false);
        setTab("workout");
      };

      const startRunFromPreview = () => {
        if (!previewRun || !previewDay) return;
        setRunSession({
          name: previewRun.name,
          day: previewDay,
          distance: previewRun.distance,
          pace: previewRun.pace,
          notes: previewRun.notes
        });
        setTimer(0);
        setRunning(false);
        setTab("run");
      };

      const loadMoreWeeks = () => {
        if (weeks.length === 0) return;
        const lastWeekStart = weeks[weeks.length - 1];
        const newWeeks = [];
        for (let i = 1; i <= 6; i++) {
          newWeeks.push(addDays(lastWeekStart, i * 7));
        }
        setWeeks(prev => [...prev, ...newWeeks]);
      };

      const handleCalendarScroll = e => {
        const el = e.target;
        if (el.scrollHeight - el.scrollTop - el.clientHeight < 80) {
          loadMoreWeeks();
        }
      };

      const isSameDay = (d1, d2) =>
        d1.getFullYear() === d2.getFullYear() &&
        d1.getMonth() === d2.getMonth() &&
        d1.getDate() === d2.getDate();

      const monthLabel = date =>
        date.toLocaleString("default", { month: "long", year: "numeric" });

      const buildCalendarRows = () => {
        const rows = [];
        let lastMonth = null;

        weeks.forEach(weekStart => {
          const weekMonth = weekStart.getMonth();
          const weekYear = weekStart.getFullYear();
          const label = monthLabel(weekStart);

          if (lastMonth === null || lastMonth.month !== weekMonth || lastMonth.year !== weekYear) {
            rows.push({
              type: "month",
              key: `month-${weekYear}-${weekMonth}`,
              label
            });
            lastMonth = { month: weekMonth, year: weekYear };
          }

          const days = [];
          for (let i = 0; i < 7; i++) {
            const date = addDays(weekStart, i);
            days.push(date);
          }

          rows.push({
            type: "week",
            key: `week-${weekStart.getTime()}`,
            days
          });
        });

        return rows;
      };

      const calendarRows = buildCalendarRows();

      const handleDayCardClick = weekday => {
        setExpandedWeekday(prev => (prev === weekday ? null : weekday));
      };

      const todayWeekdayIndex = today.getDay();
      const todayWeekdayName = WEEK_DAYS[todayWeekdayIndex === 0 ? 6 : todayWeekdayIndex - 1];

      const getDotColorForWeekday = weekday => {
        const hasGym = hasGymOnWeekday(weekday);
        const hasRun = !!getRunForWeekday(weekday);
        if (hasGym && hasRun) return "both";
        if (hasGym) return "gym";
        if (hasRun) return "run";
        return null;
      };

      const getDotColorForDate = date => {
        const weekdayIndex = date.getDay();
        const weekdayName = WEEK_DAYS[weekdayIndex === 0 ? 6 : weekdayIndex - 1];
        return getDotColorForWeekday(weekdayName);
      };

      const openDayFromCalendar = (date) => {
        const weekdayIndex = date.getDay();
        const weekdayName = WEEK_DAYS[weekdayIndex === 0 ? 6 : weekdayIndex - 1];
        const routinesForDay = getRoutinesForWeekday(weekdayName);
        const runForDay = getRunForWeekday(weekdayName);
        
        setSelectedCalendarDate(date);
        setDayRoutines(routinesForDay);
        setDayRun(runForDay);
      };

      const openPreviewFromDate = (routine, date) => {
        const weekdayIndex = date.getDay();
        const weekdayName = WEEK_DAYS[weekdayIndex === 0 ? 6 : weekdayIndex - 1];
        setPreviewRoutine(routine);
        setPreviewDay(weekdayName);
        setPreviewRun(null);
        setTab("preview");
      };

      const openRunPreviewFromDate = (run, date) => {
        const weekdayIndex = date.getDay();
        const weekdayName = WEEK_DAYS[weekdayIndex === 0 ? 6 : weekdayIndex - 1];
        setPreviewRun(run);
        setPreviewDay(weekdayName);
        setPreviewRoutine(null);
        setTab("previewRun");
      };

      return (
        <div className="max-w-md mx-auto min-h-screen pb-28 bg-black text-white">

          {/* HEADER */}
          <div className="px-6 pt-6 pb-2">
            {tab === "home" && !creating && (
              <>
                <p className="text-xs text-[#8E8E93] mb-1">Plan your training</p>
                <h1 className="text-3xl font-semibold tracking-tight">Your gym planner</h1>
              </>
            )}

            {tab === "home" && creating && (
              <h1 className="text-3xl font-semibold tracking-tight">Create {routineType === "gym" ? "routine" : "run"}</h1>
            )}

            {tab === "workout" && workoutRoutine && (
              <h1 className="text-3xl font-semibold tracking-tight">
                {workoutRoutine.name}
                <span className="text-sm text-[#8E8E93] ml-2">
                  ({workoutRoutine.day})
                </span>
              </h1>
            )}

            {tab === "run" && runSession && (
              <h1 className="text-3xl font-semibold tracking-tight">
                {runSession.name}
                <span className="text-sm text-[#8E8E93] ml-2">
                  ({runSession.day})
                </span>
              </h1>
            )}

            {tab === "calendar" && (
              <h1 className="text-3xl font-semibold tracking-tight">Calendar</h1>
            )}

            {tab === "preview" && previewRoutine && (
              <h1 className="text-2xl font-semibold tracking-tight">
                {previewRoutine.name}
                {previewDay && (
                  <span className="text-sm text-[#8E8E93] ml-2">
                    ({previewDay})
                  </span>
                )}
              </h1>
            )}

            {tab === "previewRun" && previewRun && (
              <h1 className="text-2xl font-semibold tracking-tight">
                {previewRun.name}
                {previewDay && (
                  <span className="text-sm text-[#8E8E93] ml-2">
                    ({previewDay})
                  </span>
                )}
              </h1>
            )}
          </div>

          {/* HOME TAB */}
          {tab === "home" && !creating && (
            <div className="px-6 space-y-6">

              {/* COMPACT WEEKLY PLAN */}
              <div>
                <h2 className="text-lg font-semibold mb-2">This week</h2>
                <div className="space-y-2">
                  {WEEK_DAYS.map((dayName, idx) => {
                    const date = addDays(weekStart, idx);
                    const routinesForDay = getRoutinesForWeekday(dayName);
                    const runForDay = getRunForWeekday(dayName);
                    const isToday = dayName === todayWeekdayName && isSameDay(date, today);
                    const isExpanded = expandedWeekday === dayName;

                    const totalExercises = routinesForDay.reduce((sum, r) => {
                      const arr = (r.workouts && r.workouts[dayName]) || [];
                      return sum + arr.length;
                    }, 0);

                    const dotType = getDotColorForWeekday(dayName);
                    const dotClass =
                      dotType === "gym" ? "bg-white" :
                      dotType === "run" ? "bg-green-400" :
                      dotType === "both" ? "bg-blue-400" : "";

                    const titleLine = (() => {
                      const gymNames = routinesForDay.map(r => r.name);
                      const runName = runForDay ? runForDay.name : null;
                      if (gymNames.length === 0 && !runName) return "Rest";
                      if (gymNames.length > 0 && !runName) return gymNames.join(" • ");
                      if (gymNames.length === 0 && runName) return runName;
                      return `${gymNames.join(" • ")} + ${runName}`;
                    })();

                    return (
                      <div key={dayName}>
                        <button
                          onClick={() => handleDayCardClick(dayName)}
                          className="w-full bg-[#1C1C1E] soft-border rounded-2xl px-3 py-2 text-left active:scale-[0.98] transition"
                        >
                          <div className="flex justify-between items-center">
                            <div className="flex items-center gap-2">
                              <span className="text-[10px] text-[#8E8E93] uppercase tracking-wide w-8">
                                {dayName}
                              </span>
                              {isToday && (
                                <span className="text-[9px] px-1.5 py-0.5 rounded-full bg-[#FF3B30] text-white">
                                  Today
                                </span>
                              )}
                              <div className="text-xs font-medium">
                                {titleLine}
                              </div>
                            </div>
                            {dotType && (
                              <div className={`w-1.5 h-1.5 rounded-full ${dotClass}`}></div>
                            )}
                          </div>
                        </button>

                        {isExpanded && (routinesForDay.length > 0 || runForDay) && (
                          <div className="mt-2 ml-2 space-y-2">
                            {routinesForDay.map(r => {
                              const exercises = (r.workouts && r.workouts[dayName]) || [];
                              return (
                                <div key={r.name} className="bg-[#1C1C1E] soft-border rounded-xl p-2">
                                  <div className="flex justify-between items-center mb-1">
                                    <span className="text-xs font-semibold">{r.name}</span>
                                    <span className="text-[10px] text-[#8E8E93]">
                                      {exercises.length} exercise{exercises.length !== 1 ? "s" : ""}
                                    </span>
                                  </div>
                                  <button
                                    onClick={() => {
                                      setPreviewRoutine(r);
                                      setPreviewDay(dayName);
                                      setPreviewRun(null);
                                      setTab("preview");
                                    }}
                                    className="mt-1 w-full bg-white text-black rounded-full py-1.5 text-[10px] font-semibold soft-glow active:scale-95"
                                  >
                                    View
                                  </button>
                                </div>
                              );
                            })}

                            {runForDay && (
                              <div className="bg-[#1C1C1E] soft-border rounded-xl p-2">
                                <div className="flex justify-between items-center mb-1">
                                  <span className="text-xs font-semibold">{runForDay.name}</span>
                                  <span className="text-[10px] text-[#8E8E93]">
                                    {runForDay.distance ? `${runForDay.distance} km` : "Run"}
                                  </span>
                                </div>
                                <div className="flex gap-1 mt-1">
                                  <button
                                    onClick={() => {
                                      setPreviewRun({ ...runForDay, day: dayName });
                                      setPreviewDay(dayName);
                                      setPreviewRoutine(null);
                                      setTab("previewRun");
                                    }}
                                    className="flex-1 bg-white text-black rounded-full py-1.5 text-[10px] font-semibold soft-glow active:scale-95"
                                  >
                                    View
                                  </button>
                                  <button
                                    onClick={() => deleteRunForDay(dayName)}
                                    className="px-2 py-1.5 rounded-full text-[10px] text-[#FF453A] border border-[#FF453A]/40"
                                  >
                                    Delete
                                  </button>
                                </div>
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>

              {/* ROUTINES LIST */}
              <div>
                <h2 className="text-lg font-semibold mb-3">All gym routines</h2>
                {Object.keys(routines).length === 0 && (
                  <p className="text-xs text-[#636366]">
                    No routines yet. Tap + to create one.
                  </p>
                )}
                <div className="grid grid-cols-1 gap-4">
                  {Object.values(routines).map(r => (
                    <div key={r.name} className="bg-[#1C1C1E] soft-border rounded-[24px] p-4 text-left">
                      <div className="flex justify-between items-center mb-1">
                        <h3 className="font-semibold text-base">{r.name}</h3>
                        <button onClick={() => deleteRoutine(r.name)} className="text-[11px] text-[#FF453A]">
                          Delete
                        </button>
                      </div>
                      <p className="text-[11px] text-[#8E8E93] mb-1">
                        {r.days && r.days.length > 0 ? `Days: ${r.days.join(", ")}` : "No days assigned"}
                      </p>
                      <p className="text-[11px] text-[#8E8E93]">
                        Total exercises: {Object.values(r.workouts || {}).reduce((sum, arr) => sum + arr.length, 0)}
                      </p>
                    </div>
                  ))}
                </div>
              </div>

              {/* RUNNING SUMMARY */}
              <div>
                <h2 className="text-lg font-semibold mb-3">Running plan</h2>
                {Object.keys(runningSessions).length === 0 && (
                  <p className="text-xs text-[#636366]">
                    No runs yet. Create a running session from the + button.
                  </p>
                )}
                <div className="space-y-2">
                  {WEEK_DAYS.map(day => {
                    const run = runningSessions[day];
                    if (!run) return null;
                    return (
                      <div key={day} className="bg-[#1C1C1E] soft-border rounded-2xl p-3 flex justify-between items-center">
                        <div>
                          <p className="text-xs text-[#8E8E93] uppercase tracking-wide">{day}</p>
                          <p className="text-sm font-semibold">{run.name}</p>
                          <p className="text-[11px] text-[#8E8E93]">
                            {run.distance ? `${run.distance} km` : ""}{run.pace ? ` • ${run.pace}` : ""}
                          </p>
                        </div>
                        <span className="w-2 h-2 rounded-full bg-green-400"></span>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          )}

          {/* CREATE ROUTINE / RUN SCREEN */}
          {tab === "home" && creating && (
            <div className="px-6 space-y-6">
              <div className="flex bg-[#1C1C1E] soft-border rounded-full p-1 text-xs">
                <button
                  onClick={() => {
                    setRoutineType("gym");
                    setSelectedDays([]);
                    setActiveDayTab(null);
                  }}
                  className={`flex-1 py-2 rounded-full ${
                    routineType === "gym" ? "bg-white text-black" : "text-[#8E8E93]"
                  }`}
                >
                  Gym routine
                </button>
                <button
                  onClick={() => {
                    setRoutineType("run");
                    setSelectedDays([]);
                    setActiveDayTab(null);
                  }}
                  className={`flex-1 py-2 rounded-full ${
                    routineType === "run" ? "bg-white text-black" : "text-[#8E8E93]"
                  }`}
                >
                  Running session
                </button>
              </div>

              <div className="space-y-2">
                <label className="text-xs text-[#8E8E93]">
                  {routineType === "gym" ? "Routine name" : "Run name"}
                </label>
                <input
                  value={routineName}
                  onChange={e => setRoutineName(e.target.value)}
                  placeholder={routineType === "gym" ? "e.g. Push Day" : "e.g. 5km Easy Run"}
                  className="w-full bg-[#1C1C1E] soft-border rounded-full px-4 py-3 text-sm text-white placeholder:text-[#636366]"
                />
              </div>

              <div className="space-y-2">
                <p className="text-xs text-[#8E8E93]">Days</p>
                <div className="flex flex-wrap gap-2">
                  {WEEK_DAYS.map(d => {
                    const active = selectedDays.includes(d);
                    const hasRunAlready = routineType === "run" && runningSessions[d];
                    return (
                      <button
                        key={d}
                        onClick={() => toggleDaySelection(d)}
                        disabled={hasRunAlready}
                        className={`px-3 py-1.5 rounded-full text-[11px] border transition ${
                          active
                            ? "border-white text-white bg-[#1C1C1E]"
                            : "border-[#3A3A3C] text-[#E5E5EA] bg-[#0C0C0C]"
                        } ${hasRunAlready ? "opacity-40 cursor-not-allowed" : ""}`}
                      >
                        {d}{hasRunAlready && routineType === "run" ? " (run set)" : ""}
                      </button>
                    );
                  })}
                </div>
              </div>

              {routineType === "gym" && (
                <>
                  {selectedDays.length > 0 && (
                    <div className="space-y-3">
                      <div className="flex border-b border-[#2C2C2E]">
                        {selectedDays.map(day => {
                          const active = day === activeDayTab;
                          return (
                            <button
                              key={day}
                              onClick={() => setActiveDayTab(day)}
                              className={`mr-4 pb-2 text-xs ${
                                active ? "text-white" : "text-[#8E8E93]"
                              }`}
                            >
                              <div>{day}</div>
                              {active && (
                                <div className="h-0.5 bg-white rounded-full mt-1"></div>
                              )}
                            </button>
                          );
                        })}
                      </div>

                      {activeDayTab && (
                        <div className="space-y-3 mt-2">
                          <p className="text-[11px] text-[#8E8E93]">
                            Exercises for {activeDayTab}
                          </p>
                          <div className="space-y-2">
                            {(dayWorkouts[activeDayTab] || []).length === 0 && (
                              <p className="text-[11px] text-[#636366]">
                                No exercises yet. Tap "Add exercise".
                              </p>
                            )}
                            {(dayWorkouts[activeDayTab] || []).map((ex, i) => (
                              <div key={i} className="bg-[#1C1C1E] soft-border rounded-2xl p-3">
                                <p className="font-semibold text-sm">{ex.name}</p>
                                <p className="text-[11px] text-
