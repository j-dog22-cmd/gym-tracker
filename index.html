<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Gym + Run Planner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        background: black;
        height: 100%;
        width: 100%;
      }

      #root {
        height: 100%;
        width: 100%;
      }

      .soft-border {
        box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.06);
      }

      .glass-nav {
        background: rgba(28, 28, 30, 0.9);
        backdrop-filter: blur(20px);
      }

      .bottom-sheet-backdrop {
        background: rgba(0, 0, 0, 0.5);
      }
    </style>
  </head>
  <body class="bg-black text-white">
    <div id="root"></div>

    <script type="text/babel">
      const WEEK_DAYS = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

      function ProgressRing({ value, goal, label }) {
        const radius = 42;
        const stroke = 8;
        const normalizedRadius = radius - stroke;
        const circumference = normalizedRadius * 2 * Math.PI;
        const progress = Math.min(value / Math.max(goal, 1), 1);
        const strokeDashoffset = circumference - progress * circumference;

        return (
          <div className="flex flex-col items-center">
            <svg height={radius * 2} width={radius * 2}>
              <circle
                stroke="#2C2C2E"
                fill="transparent"
                strokeWidth={stroke}
                r={normalizedRadius}
                cx={radius}
                cy={radius}
              />
              <circle
                stroke="#34C759"
                fill="transparent"
                strokeWidth={stroke}
                strokeLinecap="round"
                r={normalizedRadius}
                cx={radius}
                cy={radius}
                strokeDasharray={circumference + " " + circumference}
                strokeDashoffset={strokeDashoffset}
                style={{ transition: "stroke-dashoffset 0.35s" }}
              />
            </svg>

            <p className="text-sm mt-2 text-[#8E8E93]">{label}</p>
            <p className="text-lg font-semibold mt-0.5">
              {value}/{goal}
            </p>
          </div>
        );
      }

      function App() {
        const today = new Date();
        const [tab, setTab] = React.useState("home");

        // SETTINGS
        const [userName, setUserName] = React.useState(
          localStorage.getItem("userName") || "Joby"
        );
        const [weeklyGymGoal, setWeeklyGymGoal] = React.useState(
          Number(localStorage.getItem("weeklyGymGoal") || 3)
        );
        const [weeklyRunGoal, setWeeklyRunGoal] = React.useState(
          Number(localStorage.getItem("weeklyRunGoal") || 3)
        );
        const [monthlyWorkoutGoal, setMonthlyWorkoutGoal] = React.useState(
          Number(localStorage.getItem("monthlyWorkoutGoal") || 16)
        );
        const [restTime, setRestTime] = React.useState(
          Number(localStorage.getItem("restTime") || 90)
        );

        // PLANS
        const [gymPlan, setGymPlan] = React.useState(() => {
          const saved = localStorage.getItem("gymPlan_v1");
          return saved ? JSON.parse(saved) : {};
        });

        const [runPlan, setRunPlan] = React.useState(() => {
          const saved = localStorage.getItem("runPlan_v1");
          return saved ? JSON.parse(saved) : {};
        });

        // LOGS
        const [workoutLogs, setWorkoutLogs] = React.useState(() => {
          const saved = localStorage.getItem("workoutLogs_v1");
          return saved ? JSON.parse(saved) : [];
        });

        const [runLogs, setRunLogs] = React.useState(() => {
          const saved = localStorage.getItem("runLogs_v1");
          return saved ? JSON.parse(saved) : [];
        });

        // MODALS
        const [showGymCreator, setShowGymCreator] = React.useState(false);
        const [showRunCreator, setShowRunCreator] = React.useState(false);
        const [showCreateChooser, setShowCreateChooser] =
          React.useState(false);

        // GYM CREATOR
        const [newRoutineName, setNewRoutineName] = React.useState("");
        const [newExerciseName, setNewExerciseName] = React.useState("");
        const [newExerciseSets, setNewExerciseSets] = React.useState("");
        const [newExerciseReps, setNewExerciseReps] = React.useState("");
        const [tempExercises, setTempExercises] = React.useState([]);

        // RUN CREATOR
        const [newRunType, setNewRunType] = React.useState("");
        const [newRunDistance, setNewRunDistance] = React.useState("");
        const [newRunPace, setNewRunPace] = React.useState("");

        // ACTIVE WORKOUT
        const [activeWorkout, setActiveWorkout] = React.useState(null);

        // REST TIMER
        const [restRemaining, setRestRemaining] = React.useState(0);
        const [isResting, setIsResting] = React.useState(false);

        // HOME WEEK SELECTION
        const [selectedHomeDate, setSelectedHomeDate] =
          React.useState(today);

        // CALENDAR
        const [calendarDate, setCalendarDate] = React.useState(
          new Date(today.getFullYear(), today.getMonth(), 1)
        );
        const [selectedCalendarDate, setSelectedCalendarDate] =
          React.useState(null);
        const [showDaySheet, setShowDaySheet] = React.useState(false);

        // PERSIST
        React.useEffect(() => {
          localStorage.setItem("userName", userName);
        }, [userName]);

        React.useEffect(() => {
          localStorage.setItem("weeklyGymGoal", weeklyGymGoal);
        }, [weeklyGymGoal]);

        React.useEffect(() => {
          localStorage.setItem("weeklyRunGoal", weeklyRunGoal);
        }, [weeklyRunGoal]);

        React.useEffect(() => {
          localStorage.setItem(
            "monthlyWorkoutGoal",
            monthlyWorkoutGoal
          );
        }, [monthlyWorkoutGoal]);

        React.useEffect(() => {
          localStorage.setItem("restTime", restTime);
        }, [restTime]);

        React.useEffect(() => {
          localStorage.setItem("gymPlan_v1", JSON.stringify(gymPlan));
        }, [gymPlan]);

        React.useEffect(() => {
          localStorage.setItem("runPlan_v1", JSON.stringify(runPlan));
        }, [runPlan]);

        React.useEffect(() => {
          localStorage.setItem(
            "workoutLogs_v1",
            JSON.stringify(workoutLogs)
          );
        }, [workoutLogs]);

        React.useEffect(() => {
          localStorage.setItem("runLogs_v1", JSON.stringify(runLogs));
        }, [runLogs]);

        // REST TIMER EFFECT
        React.useEffect(() => {
          if (!isResting || restRemaining <= 0) return;

          const timer = setInterval(() => {
            setRestRemaining((prev) => {
              if (prev <= 1) {
                setIsResting(false);
                return 0;
              }
              return prev - 1;
            });
          }, 1000);

          return () => clearInterval(timer);
        }, [isResting, restRemaining]);

        // RESET APP
        function resetApp() {
          if (
            !confirm(
              "Are you sure you want to reset everything? This will clear all plans, logs, and settings."
            )
          )
            return;

          localStorage.removeItem("gymPlan_v1");
          localStorage.removeItem("runPlan_v1");
          localStorage.removeItem("workoutLogs_v1");
          localStorage.removeItem("runLogs_v1");
          localStorage.removeItem("userName");
          localStorage.removeItem("weeklyGymGoal");
          localStorage.removeItem("weeklyRunGoal");
          localStorage.removeItem("monthlyWorkoutGoal");
          localStorage.removeItem("restTime");

          setGymPlan({});
          setRunPlan({});
          setWorkoutLogs([]);
          setRunLogs([]);
          setUserName("Joby");
          setWeeklyGymGoal(3);
          setWeeklyRunGoal(3);
          setMonthlyWorkoutGoal(16);
          setRestTime(90);

          setSelectedHomeDate(new Date());
          setCalendarDate(
            new Date(
              new Date().getFullYear(),
              new Date().getMonth(),
              1
            )
          );
          setSelectedCalendarDate(null);
          setShowDaySheet(false);
          setActiveWorkout(null);
          setIsResting(false);
          setRestRemaining(0);

          alert("App has been reset.");
        }

        // HELPERS
        function addTempExercise() {
          if (!newExerciseName || !newExerciseSets || !newExerciseReps)
            return;
          setTempExercises((prev) => [
            ...prev,
            {
              name: newExerciseName,
              sets: Number(newExerciseSets),
              reps: Number(newExerciseReps),
            },
          ]);
          setNewExerciseName("");
          setNewExerciseSets("");
          setNewExerciseReps("");
        }

        function saveNewRoutine() {
          if (!newRoutineName || tempExercises.length === 0) return;
          setNewRoutineName("");
          setTempExercises([]);
          setShowGymCreator(false);
        }

        function saveNewRoutineToDay(day) {
          if (!newRoutineName || tempExercises.length === 0) return;
          setGymPlan((prev) => ({
            ...prev,
            [day]: {
              name: newRoutineName,
              exercises: tempExercises,
            },
          }));
          setNewRoutineName("");
          setTempExercises([]);
          setShowGymCreator(false);
        }

        function saveNewRunRoutine() {
          if (!newRunType || !newRunDistance || !newRunPace) return;
          setNewRunType("");
          setNewRunDistance("");
          setNewRunPace("");
          setShowRunCreator(false);
        }

        function saveNewRunRoutineToDay(day) {
          if (!newRunType || !newRunDistance || !newRunPace) return;
          setRunPlan((prev) => ({
            ...prev,
            [day]: {
              type: newRunType,
              distance: Number(newRunDistance),
              pace: newRunPace,
            },
          }));
          setNewRunType("");
          setNewRunDistance("");
          setNewRunPace("");
          setShowRunCreator(false);
        }

        function deleteGymRoutine(name) {
          const updated = { ...gymPlan };
          for (const day of WEEK_DAYS) {
            if (updated[day] && updated[day].name === name) {
              delete updated[day];
            }
          }
          setGymPlan(updated);
        }

        function deleteRunRoutine(type) {
          const updated = { ...runPlan };
          for (const day of WEEK_DAYS) {
            if (updated[day] && updated[day].type === type) {
              delete updated[day];
            }
          }
          setRunPlan(updated);
        }

        function startWorkout(routine, dateForLog = new Date()) {
          const completed = routine.exercises.map((ex) =>
            Array(ex.sets).fill(false)
          );
          setActiveWorkout({
            routine,
            completed,
            dateForLog,
          });
          setIsResting(false);
          setRestRemaining(0);
          setTab("workout");
        }

        function completeSet(exIndex, setIndex) {
          if (!activeWorkout || isResting) return;

          let { routine, completed, dateForLog } = activeWorkout;

          const newCompleted = completed.map((row, i) =>
            row.map((done, j) =>
              i === exIndex && j === setIndex ? true : done
            )
          );

          const exerciseDone = newCompleted[exIndex].every((d) => d);

          let newRoutine = routine;
          let newCompletedMatrix = newCompleted;

          if (exerciseDone) {
            newRoutine = {
              ...routine,
              exercises: routine.exercises.filter((_, i) => i !== exIndex),
            };
            newCompletedMatrix = newCompleted.filter(
              (_, i) => i !== exIndex
            );
          }

          // If workout is finished
          if (newRoutine.exercises.length === 0) {
            setWorkoutLogs((prev) => [
              {
                timestamp: dateForLog.toISOString(),
                type: "gym",
              },
              ...prev,
            ]);
            setActiveWorkout(null);
            setIsResting(false);
            setRestRemaining(0);
            setTab("home");
            return;
          }

          // Start rest timer
          setIsResting(true);
          setRestRemaining(restTime);

          setActiveWorkout({
            routine: newRoutine,
            completed: newCompletedMatrix,
            dateForLog,
          });
        }

        function finishWorkout() {
          setActiveWorkout(null);
          setIsResting(false);
          setRestRemaining(0);
          setTab("home");
        }

        function logRunForDate(date) {
          setRunLogs((prev) => [
            {
              timestamp: date.toISOString(),
              type: "run",
            },
            ...prev,
          ]);
        }

        // STATS
        const currentMonthIndex = today.getMonth();
        const currentYear = today.getFullYear();

        const workoutsThisMonth = workoutLogs.filter((log) => {
          const d = new Date(log.timestamp);
          return (
            d.getMonth() === currentMonthIndex &&
            d.getFullYear() === currentYear
          );
        }).length;

        const runsThisMonth = runLogs.filter((log) => {
          const d = new Date(log.timestamp);
          return (
            d.getMonth() === currentMonthIndex &&
            d.getFullYear() === currentYear
          );
        }).length;

        const weeksInMonth = Math.ceil(
          new Date(currentYear, currentMonthIndex + 1, 0).getDate() / 7
        );
        const monthlyRunGoalCalculated = weeklyRunGoal * weeksInMonth;

        // Weekly completed (for rings) based on logs
        function getStartOfWeek(date) {
          const d = new Date(date);
          const day = (d.getDay() + 6) % 7; // Mon=0
          d.setDate(d.getDate() - day);
          d.setHours(0, 0, 0, 0);
          return d;
        }

        const startOfThisWeek = getStartOfWeek(today);
        const endOfThisWeek = new Date(startOfThisWeek);
        endOfThisWeek.setDate(startOfThisWeek.getDate() + 7);

        const weeklyGymsCompleted = workoutLogs.filter((log) => {
          const d = new Date(log.timestamp);
          return d >= startOfThisWeek && d < endOfThisWeek;
        }).length;

        const weeklyRunsCompleted = runLogs.filter((log) => {
          const d = new Date(log.timestamp);
          return d >= startOfThisWeek && d < endOfThisWeek;
        }).length;

        // HOME WEEK STRIP
        const startOfWeekStrip = getStartOfWeek(today);
        const weekDates = Array.from({ length: 7 }).map((_, i) => {
          const d = new Date(startOfWeekStrip);
          d.setDate(startOfWeekStrip.getDate() + i);
          return d;
        });

        function isSameDay(a, b) {
          return (
            a.getFullYear() === b.getFullYear() &&
            a.getMonth() === b.getMonth() &&
            a.getDate() === b.getDate()
          );
        }

        function getWeekdayFromDate(date) {
          const idx = (date.getDay() + 6) % 7;
          return WEEK_DAYS[idx];
        }

        // TODAY + TOMORROW PLANS
        function getPlanForDate(date) {
          const weekday = getWeekdayFromDate(date);
          const gym = gymPlan[weekday] || null;
          const run = runPlan[weekday] || null;
          return { gym, run };
        }

        const selectedPlan = getPlanForDate(selectedHomeDate);

        const tomorrow = new Date(selectedHomeDate);
        tomorrow.setDate(selectedHomeDate.getDate() + 1);
        const tomorrowPlan = getPlanForDate(tomorrow);

        // CALENDAR DATA
        const calYear = calendarDate.getFullYear();
        const calMonth = calendarDate.getMonth();
        const firstDayOfMonth = new Date(calYear, calMonth, 1);
        const lastDayOfMonth = new Date(calYear, calMonth + 1, 0);
        const startWeekday = (firstDayOfMonth.getDay() + 6) % 7;
        const daysInMonth = lastDayOfMonth.getDate();

        const calendarCells = [];
        for (let i = 0; i < startWeekday; i++) calendarCells.push(null);
        for (let d = 1; d <= daysInMonth; d++) {
          calendarCells.push(new Date(calYear, calMonth, d));
        }

        const activityByDateKey = {};

        workoutLogs.forEach((log) => {
          const d = new Date(log.timestamp);
          if (d.getMonth() === calMonth && d.getFullYear() === calYear) {
            const key = d.toDateString();
            if (!activityByDateKey[key]) {
              activityByDateKey[key] = { gym: 0, run: 0 };
            }
            activityByDateKey[key].gym += 1;
          }
        });

        runLogs.forEach((log) => {
          const d = new Date(log.timestamp);
          if (d.getMonth() === calMonth && d.getFullYear() === calYear) {
            const key = d.toDateString();
            if (!activityByDateKey[key]) {
              activityByDateKey[key] = { gym: 0, run: 0 };
            }
            activityByDateKey[key].run += 1;
          }
        });

        // Weekly gym + run separated (for this month)
        const weeksCount = Math.ceil(daysInMonth / 7);
        const weeklyGym = Array(weeksCount).fill(0);
        const weeklyRun = Array(weeksCount).fill(0);

        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(calYear, calMonth, day);
          const key = date.toDateString();
          const weekIndex = Math.floor((day - 1) / 7);

          if (activityByDateKey[key]) {
            weeklyGym[weekIndex] += activityByDateKey[key].gym;
            weeklyRun[weekIndex] += activityByDateKey[key].run;
          }
        }

        // DAY SHEET DATA
        function getDayDetails(date) {
          const weekday = getWeekdayFromDate(date);
          const gym = gymPlan[weekday] || null;
          const run = runPlan[weekday] || null;

          const logsForDay = workoutLogs.filter((log) => {
            const d = new Date(log.timestamp);
            return isSameDay(d, date);
          });

          const runLogsForDay = runLogs.filter((log) => {
            const d = new Date(log.timestamp);
            return isSameDay(d, date);
          });

          return { gym, run, logsForDay, runLogsForDay };
        }

        // HOME TAB
        const HomeTab = (
          <div className="w-full min-h-screen overflow-y-auto bg-black pb-32 px-4 pt-6">
            {/* HEADER */}
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-baseline gap-2">
                <p className="text-2xl font-semibold">Hello</p>
                <p className="text-2xl font-semibold">{userName}</p>
              </div>
            </div>

            {/* WEEK STRIP */}
            <div className="flex justify-between mb-4">
              {weekDates.map((date, idx) => {
                const isSelected = isSameDay(date, selectedHomeDate);
                const isToday = isSameDay(date, today);
                const dayLabel = WEEK_DAYS[(date.getDay() + 6) % 7];

                return (
                  <button
                    key={idx}
                    onClick={() => setSelectedHomeDate(date)}
                    className="flex flex-col items-center text-xs"
                  >
                    <div
                      className={
                        "px-2 py-1 rounded-full " +
                        (isSelected ? "bg-[#2C2C2E]" : "bg-transparent")
                      }
                    >
                      <p
                        className={
                          "text-sm text-center " +
                          (isToday
                            ? "text-white font-semibold"
                            : "text-[#E5E5EA]")
                        }
                      >
                        {date.getDate()}
                      </p>
                      <p
                        className={
                          "text-[11px] text-center " +
                          (isToday ? "text-white" : "text-[#8E8E93]")
                        }
                      >
                        {dayLabel}
                      </p>
                    </div>
                  </button>
                );
              })}
            </div>

            {/* RINGS - CENTERED */}
            <div className="flex justify-center gap-10 mb-6">
              <ProgressRing
                value={weeklyGymsCompleted}
                goal={weeklyGymGoal}
                label="Gym this week"
              />
              <ProgressRing
                value={weeklyRunsCompleted}
                goal={weeklyRunGoal}
                label="Runs this week"
              />
            </div>

            {/* QUICK ACTIONS */}
            <div className="mb-5 flex gap-2">
              <button
                onClick={() => setShowGymCreator(true)}
                className="flex-1 bg-[#1C1C1E] soft-border rounded-2xl py-2.5 text-sm font-semibold flex items-center justify-center gap-2"
              >
                <span>üèãÔ∏è</span>
                <span>New Workout</span>
              </button>

              <button
                onClick={() => setShowRunCreator(true)}
                className="flex-1 bg-[#1C1C1E] soft-border rounded-2xl py-2.5 text-sm font-semibold flex items-center justify-center gap-2"
              >
                <span>üèÉ‚Äç‚ôÇÔ∏è</span>
                <span>New Run</span>
              </button>
            </div>

            {/* TODAY + TOMORROW SIDE BY SIDE */}
            <div className="flex gap-2 mb-6">
              {/* TODAY BOX */}
              <div className="flex-1 bg-[#1C1C1E] soft-border rounded-2xl p-4">
                <p className="text-xs text-[#8E8E93] mb-1">
                  Today ‚Äî{" "}
                  {selectedHomeDate.toLocaleDateString(undefined, {
                    weekday: "long",
                    day: "numeric",
                    month: "short",
                  })}
                </p>

                {selectedPlan.gym || selectedPlan.run ? (
                  <>
                    {selectedPlan.gym && (
                      <>
                        <p className="text-sm mb-1">
                          üèãÔ∏è {selectedPlan.gym.name}
                        </p>
                        <button
                          onClick={() =>
                            startWorkout(
                              selectedPlan.gym,
                              selectedHomeDate
                            )
                          }
                          className="w-full bg-white text-black rounded-xl py-2 text-sm font-semibold mt-2"
                        >
                          Start Workout
                        </button>
                        <button
                          onClick={() =>
                            deleteGymRoutine(selectedPlan.gym.name)
                          }
                          className="w-full bg-red-500 text-white rounded-xl py-2 text-xs font-semibold mt-2"
                        >
                          Delete Workout
                        </button>
                      </>
                    )}

                    {selectedPlan.run && (
                      <>
                        <p className="text-sm mt-3 mb-1">
                          üèÉ‚Äç‚ôÇÔ∏è {selectedPlan.run.type} ‚Äî{" "}
                          {selectedPlan.run.distance} km
                        </p>
                        <button
                          onClick={() =>
                            logRunForDate(selectedHomeDate)
                          }
                          className="w-full bg-white text-black rounded-xl py-2 text-sm font-semibold mt-2"
                        >
                          Mark Run Done
                        </button>
                        <button
                          onClick={() =>
                            deleteRunRoutine(selectedPlan.run.type)
                          }
                          className="w-full bg-red-500 text-white rounded-xl py-2 text-xs font-semibold mt-2"
                        >
                          Delete Run
                        </button>
                      </>
                    )}
                  </>
                ) : (
                  <p className="text-sm text-[#8E8E93]">
                    No workout planned
                  </p>
                )}
              </div>

              {/* TOMORROW BOX */}
              <div className="flex-1 bg-[#1C1C1E] soft-border rounded-2xl p-4">
                <p className="text-xs text-[#8E8E93] mb-1">
                  Tomorrow ‚Äî{" "}
                  {tomorrow.toLocaleDateString(undefined, {
                    weekday: "long",
                    day: "numeric",
                    month: "short",
                  })}
                </p>

                {tomorrowPlan.gym || tomorrowPlan.run ? (
                  <>
                    {tomorrowPlan.gym && (
                      <p className="text-sm mb-1">
                        üèãÔ∏è {tomorrowPlan.gym.name}
                      </p>
                    )}
                    {tomorrowPlan.run && (
                      <p className="text-sm">
                        üèÉ‚Äç‚ôÇÔ∏è {tomorrowPlan.run.type} ‚Äî{" "}
                        {tomorrowPlan.run.distance} km
                      </p>
                    )}
                  </>
                ) : (
                  <p className="text-sm text-[#8E8E93]">
                    No workout planned
                  </p>
                )}
              </div>
            </div>

            {/* MONTHLY OVERVIEW AT BOTTOM */}
            <div className="bg-[#1C1C1E] soft-border rounded-2xl p-4 mb-6">
              <p className="text-xs text-[#8E8E93] mb-1">
                Monthly Overview
              </p>
              <div className="flex justify-between">
                <div>
                  <p className="text-[11px] uppercase tracking-wide mb-1">
                    Workouts this month
                  </p>
                  <p className="text-sm text-white font-semibold">
                    {workoutsThisMonth}/{monthlyWorkoutGoal}
                  </p>
                </div>
                <div>
                  <p className="text-[11px] uppercase tracking-wide mb-1">
                    Runs this month
                  </p>
                  <p className="text-sm text-white font-semibold">
                    {runsThisMonth}/{monthlyRunGoalCalculated}
                  </p>
                </div>
              </div>
            </div>
          </div>
        );

        // CALENDAR TAB
        const CalendarTab = (
          <div className="w-full min-h-screen overflow-y-auto bg-black pb-32 px-4 pt-6">
            <div className="flex items-center justify-between mb-4">
              <button
                onClick={() =>
                  setCalendarDate(new Date(calYear, calMonth - 1, 1))
                }
              >
                ‚óÄ
              </button>
              <h2 className="text-lg font-semibold">
                {calendarDate.toLocaleString("default", {
                  month: "long",
                })}{" "}
                {calYear}
              </h2>
              <button
                onClick={() =>
                  setCalendarDate(new Date(calYear, calMonth + 1, 1))
                }
              >
                ‚ñ∂
              </button>
            </div>

            <div className="grid grid-cols-7 text-center text-xs text-[#8E8E93] mb-1">
              {["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"].map(
                (d) => (
                  <div key={d}>{d}</div>
                )
              )}
            </div>

            <div className="grid grid-cols-7 gap-1 text-sm">
              {calendarCells.map((date, idx) => {
                if (!date) return <div key={idx}></div>;

                const key = date.toDateString();
                const activity = activityByDateKey[key] || {
                  gym: 0,
                  run: 0,
                };
                const isToday = isSameDay(date, today);

                let dot = null;
                if (activity.gym && activity.run) {
                  dot = (
                    <div className="w-1.5 h-1.5 bg-red-500 rounded-full mx-auto mt-1"></div>
                  );
                } else if (activity.gym) {
                  dot = (
                    <div className="w-1.5 h-1.5 bg-green-500 rounded-full mx-auto mt-1"></div>
                  );
                } else if (activity.run) {
                  dot = (
                    <div className="w-1.5 h-1.5 bg-blue-400 rounded-full mx-auto mt-1"></div>
                  );
                }

                return (
                  <button
                    key={idx}
                    onClick={() => {
                      setSelectedCalendarDate(date);
                      setShowDaySheet(true);
                    }}
                    className="h-10 flex flex-col items-center justify-center rounded-lg"
                  >
                    <span
                      className={
                        "text-sm " +
                        (isToday
                          ? "text-white font-semibold"
                          : "text-[#E5E5EA]")
                      }
                    >
                      {date.getDate()}
                    </span>
                    {dot}
                  </button>
                );
              })}
            </div>

            {/* GYM GRAPH (STACKED) */}
            <div className="bg-[#1C1C1E] soft-border rounded-2xl p-4 mt-6">
              <h3 className="text-lg font-semibold mb-2">Gym</h3>
              <svg width="100%" height="150">
                {/* Y-axis */}
                <line
                  x1="30"
                  y1="10"
                  x2="30"
                  y2="120"
                  stroke="#3A3A3C"
                  strokeWidth="1"
                />
                {[0, 1, 2, 3, 4, 5].map((v) => (
                  <text
                    key={v}
                    x="5"
                    y={120 - v * 20}
                    fill="#8E8E93"
                    fontSize="10"
                  >
                    {v}
                  </text>
                ))}

                {/* X-axis */}
                <line
                  x1="30"
                  y1="120"
                  x2="100%"
                  y2="120"
                  stroke="#3A3A3C"
                  strokeWidth="1"
                />

                {/* Graph line */}
                {weeklyGym.length > 0 &&
                  (() => {
                    const width = 220;
                    const stepX =
                      weeklyGym.length > 1
                        ? width / (weeklyGym.length - 1)
                        : 0;

                    const points = weeklyGym.map((v, i) => {
                      const x = 30 + stepX * i;
                      const y = 120 - (Math.min(v, 5) / 5) * 100;
                      return { x, y };
                    });

                    const polyPoints = points
                      .map((p) => `${p.x},${p.y}`)
                      .join(" ");

                    return (
                      <>
                        <polyline
                          fill="none"
                          stroke="#34C759"
                          strokeWidth="2"
                          points={polyPoints}
                        />
                        {points.map((p, i) => (
                          <g key={i}>
                            <circle
                              cx={p.x}
                              cy={p.y}
                              r="3"
                              fill="#34C759"
                            />
                            <text
                              x={p.x + 5}
                              y={135}
                              fill="#8E8E93"
                              fontSize="10"
                              textAnchor="middle"
                            >
                              W{i + 1}
                            </text>
                          </g>
                        ))}
                      </>
                    );
                  })()}
              </svg>
            </div>

            {/* RUN GRAPH (STACKED) */}
            <div className="bg-[#1C1C1E] soft-border rounded-2xl p-4 mt-6">
              <h3 className="text-lg font-semibold mb-2">Running</h3>
              <svg width="100%" height="150">
                {/* Y-axis */}
                <line
                  x1="30"
                  y1="10"
                  x2="30"
                  y2="120"
                  stroke="#3A3A3C"
                  strokeWidth="1"
                />
                {[0, 1, 2, 3, 4, 5].map((v) => (
                  <text
                    key={v}
                    x="5"
                    y={120 - v * 20}
                    fill="#8E8E93"
                    fontSize="10"
                  >
                    {v}
                  </text>
                ))}

                {/* X-axis */}
                <line
                  x1="30"
                  y1="120"
                  x2="100%"
                  y2="120"
                  stroke="#3A3A3C"
                  strokeWidth="1"
                />

                {/* Graph line */}
                {weeklyRun.length > 0 &&
                  (() => {
                    const width = 220;
                    const stepX =
                      weeklyRun.length > 1
                        ? width / (weeklyRun.length - 1)
                        : 0;

                    const points = weeklyRun.map((v, i) => {
                      const x = 30 + stepX * i;
                      const y = 120 - (Math.min(v, 5) / 5) * 100;
                      return { x, y };
                    });

                    const polyPoints = points
                      .map((p) => `${p.x},${p.y}`)
                      .join(" ");

                    return (
                      <>
                        <polyline
                          fill="none"
                          stroke="#0A84FF"
                          strokeWidth="2"
                          points={polyPoints}
                        />
                        {points.map((p, i) => (
                          <g key={i}>
                            <circle
                              cx={p.x}
                              cy={p.y}
                              r="3"
                              fill="#0A84FF"
                            />
                            <text
                              x={p.x + 5}
                              y={135}
                              fill="#8E8E93"
                              fontSize="10"
                              textAnchor="middle"
                            >
                              W{i + 1}
                            </text>
                          </g>
                        ))}
                      </>
                    );
                  })()}
              </svg>
            </div>
          </div>
        );

        // SETTINGS PAGE
        const SettingsPage = (
          <div className="w-full min-h-screen overflow-y-auto bg-black px-4 pt-6 pb-32">
            <h1 className="text-3xl font-semibold mb-6">Settings</h1>

            <label className="text-sm text-[#8E8E93]">Your Name</label>
            <input
              type="text"
              className="w-full mb-4 p-3 rounded-xl bg-[#1C1C1E] soft-border"
              value={userName}
              onChange={(e) => setUserName(e.target.value)}
            />

            <label className="text-sm text-[#8E8E93]">
              Weekly Gym Goal
            </label>
            <input
              type="number"
              className="w-full mb-4 p-3 rounded-xl bg-[#1C1C1E] soft-border"
              value={weeklyGymGoal}
              onChange={(e) =>
                setWeeklyGymGoal(Number(e.target.value))
              }
            />

            <label className="text-sm text-[#8E8E93]">
              Weekly Run Goal
            </label>
            <input
              type="number"
              className="w-full mb-4 p-3 rounded-xl bg-[#1C1C1E] soft-border"
              value={weeklyRunGoal}
              onChange={(e) =>
                setWeeklyRunGoal(Number(e.target.value))
              }
            />

            <label className="text-sm text-[#8E8E93]">
              Monthly Workout Goal
            </label>
            <input
              type="number"
              className="w-full mb-4 p-3 rounded-xl bg-[#1C1C1E] soft-border"
              value={monthlyWorkoutGoal}
              onChange={(e) =>
                setMonthlyWorkoutGoal(Number(e.target.value))
              }
            />

            <label className="text-sm text-[#8E8E93]">
              Default Rest Time (seconds)
            </label>
            <input
              type="number"
              className="w-full mb-6 p-3 rounded-xl bg-[#1C1C1E] soft-border"
              value={restTime}
              onChange={(e) => setRestTime(Number(e.target.value))}
            />

            <button
              onClick={() => setTab("home")}
              className="w-full bg-white text-black rounded-xl py-3 font-semibold"
            >
              Save Settings
            </button>

            <button
              onClick={resetApp}
              className="w-full bg-red-600 text-white rounded-xl py-3 font-semibold mt-6"
            >
              Reset App
            </button>
          </div>
        );

        // WORKOUT TAB
        const WorkoutTab =
          activeWorkout && (
            <div className="w-full min-h-screen overflow-y-auto bg-black pb-32 px-4 pt-6">
              <h2 className="text-2xl font-semibold mb-4">
                {activeWorkout.routine.name}
              </h2>

              {isResting && (
                <div className="mb-4 bg-[#1C1C1E] soft-border rounded-xl p-4 text-center">
                  <p className="text-sm text-[#8E8E93] mb-1">
                    Rest Time
                  </p>
                  <p className="text-4xl font-bold mb-3">
                    {restRemaining}s
                  </p>

                  <button
                    onClick={() => {
                      setIsResting(false);
                      setRestRemaining(0);
                    }}
                    className="w-full bg-white text-black rounded-xl py-2 text-sm font-semibold"
                  >
                    Skip Rest
                  </button>
                </div>
              )}

              {activeWorkout.routine.exercises.map((ex, exIndex) => (
                <div
                  key={exIndex}
                  className="mb-4 bg-[#1C1C1E] p-4 rounded-xl soft-border"
                >
                  <p className="font-semibold mb-1">{ex.name}</p>
                  <p className="text-xs text-[#8E8E93] mb-2">
                    {ex.sets} sets ‚Äî {ex.reps} reps
                  </p>

                  <div className="space-y-2">
                    {Array.from({ length: ex.sets }).map((_, setIndex) => {
                      const done =
                        activeWorkout.completed[exIndex] &&
                        activeWorkout.completed[exIndex][setIndex];

                      return (
                        <button
                          key={setIndex}
                          onClick={() =>
                            completeSet(exIndex, setIndex)
                          }
                          disabled={done || isResting}
                          className={`w-full flex items-center justify-between px-3 py-2 rounded-lg text-sm ${
                            done
                              ? "bg-green-500 text-black"
                              : isResting
                              ? "bg-[#3A3A3C] text-[#8E8E93]"
                              : "bg-[#2C2C2E] text-white"
                          }`}
                        >
                          <span>
                            Set {setIndex + 1} ‚Äî {ex.reps} reps
                          </span>
                          <span>
                            {done
                              ? "‚úÖ"
                              : isResting
                              ? "Resting..."
                              : "Tap to complete"}
                          </span>
                        </button>
                      );
                    })}
                  </div>
                </div>
              ))}

              <button
                onClick={finishWorkout}
                className="w-full text-[#8E8E93] mt-4"
              >
                End Workout
              </button>
            </div>
          );

        // MODALS
        const GymCreatorModal =
          showGymCreator && (
            <div className="fixed inset-0 bg-black bg-opacity-60 flex items-end z-[999]">
              <div className="w-full bg-[#1C1C1E] rounded-t-3xl p-6 soft-border">
                <h2 className="text-xl font-semibold mb-4">
                  Create Workout
                </h2>

                <input
                  type="text"
                  placeholder="Routine name"
                  className="w-full mb-3 p-3 rounded-xl bg-[#2C2C2E]"
                  value={newRoutineName}
                  onChange={(e) => setNewRoutineName(e.target.value)}
                />

                <div className="mb-3">
                  <div className="flex gap-2 mb-2">
                    <input
                      type="text"
                      placeholder="Exercise"
                      className="flex-1 p-3 rounded-xl bg-[#2C2C2E]"
                      value={newExerciseName}
                      onChange={(e) =>
                        setNewExerciseName(e.target.value)
                      }
                    />
                    <input
                      type="number"
                      placeholder="Sets"
                      className="w-20 p-3 rounded-xl bg-[#2C2C2E]"
                      value={newExerciseSets}
                      onChange={(e) =>
                        setNewExerciseSets(e.target.value)
                      }
                    />
                    <input
                      type="number"
                      placeholder="Reps"
                      className="w-20 p-3 rounded-xl bg-[#2C2C2E]"
                      value={newExerciseReps}
                      onChange={(e) =>
                        setNewExerciseReps(e.target.value)
                      }
                    />
                  </div>

                  <button
                    onClick={addTempExercise}
                    className="w-full bg-white text-black rounded-xl py-2 text-sm font-semibold"
                  >
                    Add Exercise
                  </button>
                </div>

                {tempExercises.length > 0 && (
                  <div className="mb-4">
                    <p className="text-sm text-[#8E8E93] mb-1">
                      Exercises:
                    </p>
                    <ul className="text-sm text-[#E5E5EA] space-y-1">
                      {tempExercises.map((ex, i) => (
                        <li key={i}>
                          {ex.name} ‚Äî {ex.sets}√ó{ex.reps}
                        </li>
                      ))}
                    </ul>
                  </div>
                )}

                {tempExercises.length > 0 && newRoutineName && (
                  <>
                    <p className="text-sm text-[#8E8E93] mb-2">
                      Assign to day (optional)
                    </p>
                    <div className="grid grid-cols-7 gap-2 mb-4">
                      {WEEK_DAYS.map((day) => (
                        <button
                          key={day}
                          onClick={() => saveNewRoutineToDay(day)}
                          className="bg-[#2C2C2E] rounded-xl py-2 text-sm"
                        >
                          {day}
                        </button>
                      ))}
                    </div>
                  </>
                )}

                <button
                  onClick={saveNewRoutine}
                  className="w-full bg-white text-black rounded-xl py-3 font-semibold mt-2"
                >
                  Save Workout
                </button>

                <button
                  onClick={() => {
                    setShowGymCreator(false);
                    setTempExercises([]);
                  }}
                  className="w-full text-[#8E8E93] mt-3"
                >
                  Cancel
                </button>
              </div>
            </div>
          );

        const RunCreatorModal =
          showRunCreator && (
            <div className="fixed inset-0 bg-black bg-opacity-60 flex items-end z-[999]">
              <div className="w-full bg-[#1C1C1E] rounded-t-3xl p-6 soft-border">
                <h2 className="text-xl font-semibold mb-4">
                  Create Running Routine
                </h2>

                <input
                  type="text"
                  placeholder="Type (e.g., Tempo, Easy, Long)"
                  className="w-full mb-3 p-3 rounded-xl bg-[#2C2C2E]"
                  value={newRunType}
                  onChange={(e) => setNewRunType(e.target.value)}
                />

                <input
                  type="number"
                  placeholder="Distance (km)"
                  className="w-full mb-3 p-3 rounded-xl bg-[#2C2C2E]"
                  value={newRunDistance}
                  onChange={(e) =>
                    setNewRunDistance(e.target.value)
                  }
                />

                <input
                  type="text"
                  placeholder="Pace (e.g., 5:00/km)"
                  className="w-full mb-3 p-3 rounded-xl bg-[#2C2C2E]"
                  value={newRunPace}
                  onChange={(e) => setNewRunPace(e.target.value)}
                />

                {newRunType && newRunDistance && newRunPace && (
                  <>
                    <p className="text-sm text-[#8E8E93] mb-2">
                      Assign to day (optional)
                    </p>

                    <div className="grid grid-cols-7 gap-2 mb-4">
                      {WEEK_DAYS.map((day) => (
                        <button
                          key={day}
                          onClick={() =>
                            saveNewRunRoutineToDay(day)
                          }
                          className="bg-[#2C2C2E] rounded-xl py-2 text-sm"
                        >
                          {day}
                        </button>
                      ))}
                    </div>
                  </>
                )}

                <button
                  onClick={saveNewRunRoutine}
                  className="w-full bg-white text-black rounded-xl py-3 font-semibold mt-2"
                >
                  Save Running Routine
                </button>

                <button
                  onClick={() => setShowRunCreator(false)}
                  className="w-full text-[#8E8E93] mt-3"
                >
                  Cancel
                </button>
              </div>
            </div>
          );

        const CreateChooserModal =
          showCreateChooser && (
            <div className="fixed inset-0 bg-black bg-opacity-60 flex items-end z-[999]">
              <div className="w-full bg-[#1C1C1E] rounded-t-3xl p-6 soft-border">
                <h2 className="text-xl font-semibold mb-4">Create</h2>

                <button
                  onClick={() => {
                    setShowCreateChooser(false);
                    setShowGymCreator(true);
                  }}
                  className="w-full bg-[#2C2C2E] rounded-xl p-4 mb-3 text-left"
                >
                  <p className="font-semibold">Gym Routine</p>
                  <p className="text-sm text-[#8E8E93]">
                    Build a strength workout with exercises
                  </p>
                </button>

                <button
                  onClick={() => {
                    setShowCreateChooser(false);
                    setShowRunCreator(true);
                  }}
                  className="w-full bg-[#2C2C2E] rounded-xl p-4 mb-3 text-left"
                >
                  <p className="font-semibold">Running Routine</p>
                  <p className="text-sm text-[#8E8E93]">
                    Plan a structured run with distance and pace
                  </p>
                </button>

                <button
                  onClick={() => setShowCreateChooser(false)}
                  className="w-full text-[#8E8E93] mt-3"
                >
                  Cancel
                </button>
              </div>
            </div>
          );

        // DAY BOTTOM SHEET
        const DaySheet =
          showDaySheet && selectedCalendarDate && (
            <div className="fixed inset-0 z-[900] flex flex-col justify-end">
              <div
                className="flex-1 bottom-sheet-backdrop"
                onClick={() => setShowDaySheet(false)}
              ></div>
              <div className="w-full bg-[#1C1C1E] rounded-t-3xl p-4 soft-border max-h-[60vh] overflow-y-auto">
                <div className="w-10 h-1 rounded-full bg-[#3A3A3C] mx-auto mb-3"></div>
                <h3 className="text-lg font-semibold mb-2">
                  {selectedCalendarDate.toLocaleDateString(undefined, {
                    weekday: "long",
                    day: "numeric",
                    month: "short",
                  })}
                </h3>

                {(() => {
                  const details = getDayDetails(selectedCalendarDate);
                  const { gym, run, logsForDay, runLogsForDay } = details;

                  if (
                    !gym &&
                    !run &&
                    logsForDay.length === 0 &&
                    runLogsForDay.length === 0
                  ) {
                    return (
                      <p className="text-sm text-[#8E8E93]">
                        No workout planned or logged.
                      </p>
                    );
                  }

                  return (
                    <div className="space-y-4">
                      {gym && (
                        <div className="bg-[#2C2C2E] rounded-xl p-3">
                          <p className="text-sm font-semibold mb-1">
                            Gym: {gym.name}
                          </p>
                          <p className="text-xs text-[#8E8E93] mb-2">
                            {gym.exercises.length} exercises
                          </p>
                          <button
                            onClick={() => {
                              startWorkout(
                                gym,
                                selectedCalendarDate
                              );
                              setShowDaySheet(false);
                            }}
                            className="w-full bg-white text-black rounded-xl py-2 text-sm font-semibold"
                          >
                            Start Workout
                          </button>
                        </div>
                      )}

                      {run && (
                        <div className="bg-[#2C2C2E] rounded-xl p-3">
                          <p className="text-sm font-semibold mb-1">
                            Run: {run.type}
                          </p>
                          <p className="text-xs text-[#8E8E93] mb-2">
                            {run.distance} km ‚Äî {run.pace}
                          </p>
                          <button
                            onClick={() => {
                              logRunForDate(selectedCalendarDate);
                              setShowDaySheet(false);
                            }}
                            className="w-full bg-white text-black rounded-xl py-2 text-sm font-semibold"
                          >
                            Mark Run Done
                          </button>
                        </div>
                      )}

                      {logsForDay.length > 0 && (
                        <div className="bg-[#2C2C2E] rounded-xl p-3">
                          <p className="text-sm font-semibold mb-1">
                            Completed Workouts
                          </p>
                          <p className="text-xs text-[#8E8E93]">
                            {logsForDay.length} workout
                            {logsForDay.length > 1 ? "s" : ""} logged
                          </p>
                        </div>
                      )}

                      {runLogsForDay.length > 0 && (
                        <div className="bg-[#2C2C2E] rounded-xl p-3">
                          <p className="text-sm font-semibold mb-1">
                            Completed Runs
                          </p>
                          <p className="text-xs text-[#8E8E93]">
                            {runLogsForDay.length} run
                            {runLogsForDay.length > 1 ? "s" : ""} logged
                          </p>
                        </div>
                      )}
                    </div>
                  );
                })()}
              </div>
            </div>
          );

        // FINAL RENDER
        return (
          <div className="w-full h-screen relative overflow-hidden">
            {tab === "home" && HomeTab}
            {tab === "calendar" && CalendarTab}
            {tab === "settings" && SettingsPage}
            {tab === "workout" && WorkoutTab}

            {/* BOTTOM NAV - ALWAYS VISIBLE */}
            <div className="fixed bottom-4 left-0 right-0 flex justify-center z-[50]">
              <div className="glass-nav soft-border rounded-[24px] py-2.5 px-6 flex gap-10 items-center">
                <button
                  onClick={() => setTab("home")}
                  className={`flex flex-col items-center text-xs ${
                    tab === "home" ? "text-white" : "text-[#8E8E93]"
                  }`}
                >
                  <span className="mb-1">üè†</span>
                  <span>Home</span>
                </button>

                <button
                  onClick={() => setShowCreateChooser(true)}
                  className="flex flex-col items-center text-xs text-white"
                >
                  <span className="mb-1 text-2xl">Ôºã</span>
                  <span>Add</span>
                </button>

                <button
                  onClick={() => setTab("calendar")}
                  className={`flex flex-col items-center text-xs ${
                    tab === "calendar"
                      ? "text-white"
                      : "text-[#8E8E93]"
                  }`}
                >
                  <span className="mb-1">üìÖ</span>
                  <span>Calendar</span>
                </button>

                <button
                  onClick={() => setTab("settings")}
                  className={`flex flex-col items-center text-xs ${
                    tab === "settings"
                      ? "text-white"
                      : "text-[#8E8E93]"
                  }`}
                >
                  <span className="mb-1">‚öôÔ∏è</span>
                  <span>Settings</span>
                </button>
              </div>
            </div>

            {/* MODALS */}
            {GymCreatorModal}
            {RunCreatorModal}
            {CreateChooserModal}
            {DaySheet}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
