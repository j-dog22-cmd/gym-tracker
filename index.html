<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gym + Running Planner</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700;800;900&display=swap');

    body {
      margin: 0;
      background: #000000;
      font-family: 'SF Pro Display', system-ui, -apple-system, BlinkMacSystemFont;
      color: #FFFFFF;
    }

    .glass-nav {
      backdrop-filter: blur(20px);
      background: rgba(20, 20, 20, 0.85);
    }

    .soft-border {
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .soft-glow {
      box-shadow: 0 0 18px rgba(255, 255, 255, 0.18);
    }

    .modal-slide {
      animation: slideUp 0.25s ease-out;
    }

    @keyframes slideUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .sticky-month {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #000000;
    }

    .calendar-scroll {
      max-height: none;
      overflow-y: auto;
      padding-right: 4px;
    }

    .calendar-scroll::-webkit-scrollbar {
      width: 4px;
    }

    .calendar-scroll::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.18);
      border-radius: 999px;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const WEEK_DAYS = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

    function startOfWeek(date) {
      const d = new Date(date);
      const day = d.getDay(); // 0=Sun
      const diff = (day === 0 ? -6 : 1 - day); // back to Monday
      d.setDate(d.getDate() + diff);
      d.setHours(0,0,0,0);
      return d;
    }

    function addDays(date, n) {
      const d = new Date(date);
      d.setDate(d.getDate() + n);
      return d;
    }

    function App() {
      const [tab, setTab] = useState("home");

      // Gym routines
      const [routines, setRoutines] = useState(() => {
        const saved = localStorage.getItem("routines_v3");
        return saved ? JSON.parse(saved) : {};
      });

      // Running sessions: { Mon: { name, distance, pace, notes }, ... }
      const [runningSessions, setRunningSessions] = useState(() => {
        const saved = localStorage.getItem("running_v1");
        return saved ? JSON.parse(saved) : {};
      });

      const [creating, setCreating] = useState(false);
      const [routineType, setRoutineType] = useState("gym"); // "gym" | "run"

      const [routineName, setRoutineName] = useState("");
      const [selectedDays, setSelectedDays] = useState([]);
      const [activeDayTab, setActiveDayTab] = useState(null);
      const [dayWorkouts, setDayWorkouts] = useState({});

      const [showModal, setShowModal] = useState(false);
      const [exerciseForm, setExerciseForm] = useState({
        name: "",
        sets: "",
        reps: "",
        weight: ""
      });

      // Running form
      const [runDistance, setRunDistance] = useState("");
      const [runPace, setRunPace] = useState("");
      const [runNotes, setRunNotes] = useState("");

      const [selectedCalendarDate, setSelectedCalendarDate] = useState(null);
      const [dayRoutines, setDayRoutines] = useState([]);
      const [dayRun, setDayRun] = useState(null);

      const [workoutRoutine, setWorkoutRoutine] = useState(null);
      const [runSession, setRunSession] = useState(null);

      const [timer, setTimer] = useState(0);
      const [running, setRunning] = useState(false);

      const [weeks, setWeeks] = useState([]);
      const calendarRef = useRef(null);

      const [weekStart, setWeekStart] = useState(() => startOfWeek(new Date()));
      const [expandedWeekday, setExpandedWeekday] = useState(null);

      const [previewRoutine, setPreviewRoutine] = useState(null);
      const [previewDay, setPreviewDay] = useState(null);
      const [previewRun, setPreviewRun] = useState(null);

      useEffect(() => {
        const start = startOfWeek(new Date());
        const initialWeeks = [];
        for (let i = 0; i < 6; i++) {
          initialWeeks.push(addDays(start, i * 7));
        }
        setWeeks(initialWeeks);
      }, []);

      useEffect(() => {
        if (!running) return;
        const id = setInterval(() => setTimer(t => t + 1), 1000);
        return () => clearInterval(id);
      }, [running]);

      const saveRoutines = updated => {
        setRoutines(updated);
        localStorage.setItem("routines_v3", JSON.stringify(updated));
      };

      const saveRunningSessions = updated => {
        setRunningSessions(updated);
        localStorage.setItem("running_v1", JSON.stringify(updated));
      };

      const formatTime = s =>
        `${String(Math.floor(s / 60)).padStart(2,"0")}:${String(s % 60).padStart(2,"0")}`;

      const today = new Date();
      today.setHours(0,0,0,0);

      const startCreateRoutine = () => {
        setRoutineType("gym");
        setRoutineName("");
        setSelectedDays([]);
        setActiveDayTab(null);
        setDayWorkouts({});
        setRunDistance("");
        setRunPace("");
        setRunNotes("");
        setCreating(true);
        setTab("home");
      };

      const toggleDaySelection = day => {
        // For running: enforce one run per day
        if (routineType === "run" && runningSessions[day]) {
          return; // can't select a day that already has a run
        }

        let updated;
        if (selectedDays.includes(day)) {
          updated = selectedDays.filter(d => d !== day);
        } else {
          updated = [...selectedDays, day];
        }
        setSelectedDays(updated);
        if (updated.length > 0) {
          if (!updated.includes(activeDayTab)) {
            setActiveDayTab(updated[0]);
          }
        } else {
          setActiveDayTab(null);
        }
      };

      const openAddExerciseModal = () => {
        if (!activeDayTab) return;
        setExerciseForm({ name: "", sets: "", reps: "", weight: "" });
        setShowModal(true);
      };

      const addExerciseToDay = () => {
        if (!activeDayTab || !exerciseForm.name.trim()) {
          setShowModal(false);
          return;
        }
        const current = dayWorkouts[activeDayTab] || [];
        const updated = {
          ...dayWorkouts,
          [activeDayTab]: [...current, exerciseForm]
        };
        setDayWorkouts(updated);
        setExerciseForm({ name: "", sets: "", reps: "", weight: "" });
        setShowModal(false);
      };

      const saveRoutine = () => {
        if (!routineName.trim() || selectedDays.length === 0) return;

        if (routineType === "gym") {
          const cleanedWorkouts = {};
          selectedDays.forEach(day => {
            cleanedWorkouts[day] = dayWorkouts[day] || [];
          });
          const updated = {
            ...routines,
            [routineName]: {
              name: routineName,
              days: selectedDays,
              workouts: cleanedWorkouts
            }
          };
          saveRoutines(updated);
        } else {
          // Running session: one run per selected day
          const updatedRuns = { ...runningSessions };
          selectedDays.forEach(day => {
            updatedRuns[day] = {
              name: routineName,
              distance: runDistance,
              pace: runPace,
              notes: runNotes
            };
          });
          saveRunningSessions(updatedRuns);
        }

        setCreating(false);
      };

      const deleteRoutine = name => {
        const updated = { ...routines };
        delete updated[name];
        saveRoutines(updated);
        if (workoutRoutine && workoutRoutine.name === name) {
          setWorkoutRoutine(null);
          setTab("home");
        }
      };

      const deleteRunForDay = day => {
        const updated = { ...runningSessions };
        delete updated[day];
        saveRunningSessions(updated);
      };

      const hasGymOnWeekday = weekday =>
        Object.values(routines).some(r => r.days && r.days.includes(weekday));

      const getRoutinesForWeekday = weekday =>
        Object.values(routines).filter(r => r.days && r.days.includes(weekday));

      const getRunForWeekday = weekday => runningSessions[weekday] || null;

      const openDayFromCalendar = date => {
        const d = new Date(date);
        d.setHours(0,0,0,0);
        setSelectedCalendarDate(d);

        const weekdayIndex = d.getDay(); // 0=Sun
        const weekdayName = WEEK_DAYS[weekdayIndex === 0 ? 6 : weekdayIndex - 1];

        const list = Object.values(routines).filter(r => r.days.includes(weekdayName));
        setDayRoutines(list);
        setDayRun(runningSessions[weekdayName] || null);
      };

      const openPreviewFromDate = (routine, date) => {
        const d = new Date(date);
        const weekdayIndex = d.getDay();
        const weekdayName = WEEK_DAYS[weekdayIndex === 0 ? 6 : weekdayIndex - 1];
        setPreviewRoutine(routine);
        setPreviewDay(weekdayName);
        setPreviewRun(null);
        setTab("preview");
      };

      const openRunPreviewFromDate = (run, date) => {
        const d = new Date(date);
        const weekdayIndex = d.getDay();
        const weekdayName = WEEK_DAYS[weekdayIndex === 0 ? 6 : weekdayIndex - 1];
        setPreviewRun({ ...run, day: weekdayName });
        setPreviewRoutine(null);
        setPreviewDay(weekdayName);
        setTab("previewRun");
      };

      const startWorkoutFromPreview = () => {
        if (!previewRoutine || !previewDay) return;
        const exercises = (previewRoutine.workouts && previewRoutine.workouts[previewDay]) || [];
        setWorkoutRoutine({
          name: previewRoutine.name,
          day: previewDay,
          exercises
        });
        setTimer(0);
        setRunning(false);
        setTab("workout");
      };

      const startRunFromPreview = () => {
        if (!previewRun || !previewDay) return;
        setRunSession({
          name: previewRun.name,
          day: previewDay,
          distance: previewRun.distance,
          pace: previewRun.pace,
          notes: previewRun.notes
        });
        setTimer(0);
        setRunning(false);
        setTab("run");
      };

      const loadMoreWeeks = () => {
        if (weeks.length === 0) return;
        const lastWeekStart = weeks[weeks.length - 1];
        const newWeeks = [];
        for (let i = 1; i <= 6; i++) {
          newWeeks.push(addDays(lastWeekStart, i * 7));
        }
        setWeeks(prev => [...prev, ...newWeeks]);
      };

      const handleCalendarScroll = e => {
        const el = e.target;
        if (el.scrollHeight - el.scrollTop - el.clientHeight < 80) {
          loadMoreWeeks();
        }
      };

      const isSameDay = (d1, d2) =>
        d1.getFullYear() === d2.getFullYear() &&
        d1.getMonth() === d2.getMonth() &&
        d1.getDate() === d2.getDate();

      const monthLabel = date =>
        date.toLocaleString("default", { month: "long", year: "numeric" });

      const buildCalendarRows = () => {
        const rows = [];
        let lastMonth = null;

        weeks.forEach(weekStart => {
          const weekMonth = weekStart.getMonth();
          const weekYear = weekStart.getFullYear();
          const label = monthLabel(weekStart);

          if (lastMonth === null || lastMonth.month !== weekMonth || lastMonth.year !== weekYear) {
            rows.push({
              type: "month",
              key: `month-${weekYear}-${weekMonth}`,
              label
            });
            lastMonth = { month: weekMonth, year: weekYear };
          }

          const days = [];
          for (let i = 0; i < 7; i++) {
            const date = addDays(weekStart, i);
            days.push(date);
          }

          rows.push({
            type: "week",
            key: `week-${weekStart.getTime()}`,
            days
          });
        });

        return rows;
      };

      const calendarRows = buildCalendarRows();

      const handleDayCardClick = weekday => {
        setExpandedWeekday(prev => (prev === weekday ? null : weekday));
      };

      const todayWeekdayIndex = today.getDay(); // 0=Sun
      const todayWeekdayName = WEEK_DAYS[todayWeekdayIndex === 0 ? 6 : todayWeekdayIndex - 1];

      const getDotColorForWeekday = weekday => {
        const hasGym = hasGymOnWeekday(weekday);
        const hasRun = !!getRunForWeekday(weekday);
        if (hasGym && hasRun) return "both";
        if (hasGym) return "gym";
        if (hasRun) return "run";
        return null;
      };

      const getDotColorForDate = date => {
        const weekdayIndex = date.getDay();
        const weekdayName = WEEK_DAYS[weekdayIndex === 0 ? 6 : weekdayIndex - 1];
        return getDotColorForWeekday(weekdayName);
      };

      return (
        <div className="max-w-md mx-auto min-h-screen pb-28 bg-black text-white">

          {/* HEADER */}
          <div className="px-6 pt-6 pb-2">
            {tab === "home" && !creating && (
              <>
                <p className="text-xs text-[#8E8E93] mb-1">Plan your training</p>
                <h1 className="text-3xl font-semibold tracking-tight">Your gym planner</h1>
              </>
            )}

            {tab === "home" && creating && (
              <h1 className="text-3xl font-semibold tracking-tight">Create {routineType === "gym" ? "routine" : "run"}</h1>
            )}

            {tab === "workout" && workoutRoutine && (
              <h1 className="text-3xl font-semibold tracking-tight">
                {workoutRoutine.name}
                <span className="text-sm text-[#8E8E93] ml-2">
                  ({workoutRoutine.day})
                </span>
              </h1>
            )}

            {tab === "run" && runSession && (
              <h1 className="text-3xl font-semibold tracking-tight">
                {runSession.name}
                <span className="text-sm text-[#8E8E93] ml-2">
                  ({runSession.day})
                </span>
              </h1>
            )}

            {tab === "calendar" && (
              <h1 className="text-3xl font-semibold tracking-tight">Calendar</h1>
            )}

            {tab === "preview" && previewRoutine && (
              <h1 className="text-2xl font-semibold tracking-tight">
                {previewRoutine.name}
                {previewDay && (
                  <span className="text-sm text-[#8E8E93] ml-2">
                    ({previewDay})
                  </span>
                )}
              </h1>
            )}

            {tab === "previewRun" && previewRun && (
              <h1 className="text-2xl font-semibold tracking-tight">
                {previewRun.name}
                {previewDay && (
                  <span className="text-sm text-[#8E8E93] ml-2">
                    ({previewDay})
                  </span>
                )}
              </h1>
            )}
          </div>

          {/* HOME TAB */}
          {tab === "home" && !creating && (
            <div className="px-6 space-y-8">

              {/* WEEKLY PLAN */}
              <div>
                <h2 className="text-lg font-semibold mb-3">This week</h2>
                <div className="space-y-3">
                  {WEEK_DAYS.map((dayName, idx) => {
                    const date = addDays(weekStart, idx);
                    const routinesForDay = getRoutinesForWeekday(dayName);
                    const runForDay = getRunForWeekday(dayName);
                    const isToday = dayName === todayWeekdayName &&
                      isSameDay(date, today);
                    const isExpanded = expandedWeekday === dayName;

                    const totalExercises = routinesForDay.reduce((sum, r) => {
                      const arr = (r.workouts && r.workouts[dayName]) || [];
                      return sum + arr.length;
                    }, 0);

                    const dotType = getDotColorForWeekday(dayName);

                    const dotClass =
                      dotType === "gym" ? "bg-white" :
                      dotType === "run" ? "bg-green-400" :
                      dotType === "both" ? "bg-blue-400" :
                      "";

                    const titleLine = (() => {
                      const gymNames = routinesForDay.map(r => r.name);
                      const runName = runForDay ? runForDay.name : null;
                      if (gymNames.length === 0 && !runName) return "Rest";
                      if (gymNames.length > 0 && !runName) return gymNames.join(" • ");
                      if (gymNames.length === 0 && runName) return runName;
                      return `${gymNames.join(" • ")} + ${runName}`;
                    })();

                    const secondaryLine = (() => {
                      const parts = [];
                      if (totalExercises > 0) {
                        parts.push(`${totalExercises} exercise${totalExercises !== 1 ? "s" : ""}`);
                      }
                      if (runForDay && runForDay.distance) {
                        parts.push(`${runForDay.distance} km`);
                      }
                      return parts.join(" • ") || "No details";
                    })();

                    return (
                      <div key={dayName}>
                        <button
                          onClick={() => handleDayCardClick(dayName)}
                          className="w-full bg-[#1C1C1E] soft-border rounded-[24px] px-4 py-3 text-left active:scale-[0.98] transition"
                        >
                          <div className="flex justify-between items-center mb-1">
                            <div>
                              <div className="flex items-center gap-2">
                                <span className="text-xs text-[#8E8E93] uppercase tracking-wide">
                                  {dayName}
                                </span>
                                {isToday && (
                                  <span className="text-[10px] px-2 py-0.5 rounded-full bg-[#FF3B30] text-white">
                                    Today
                                  </span>
                                )}
                              </div>
                              <div className="text-sm font-semibold mt-0.5">
                                {titleLine}
                              </div>
                            </div>
                            <div className="flex flex-col items-end">
                              {dotType && (
                                <div className={`w-2 h-2 rounded-full mb-1 ${dotClass}`}></div>
                              )}
                              <span className="text-[11px] text-[#8E8E93]">
                                {secondaryLine}
                              </span>
                            </div>
                          </div>
                        </button>

                        {isExpanded && (routinesForDay.length > 0 || runForDay) && (
                          <div className="mt-2 ml-2 space-y-3">
                            {routinesForDay.map(r => {
                              const exercises = (r.workouts && r.workouts[dayName]) || [];
                              return (
                                <div
                                  key={r.name}
                                  className="bg-[#1C1C1E] soft-border rounded-2xl p-3"
                                >
                                  <div className="flex justify-between items-center mb-1">
                                    <span className="text-sm font-semibold">{r.name}</span>
                                    <span className="text-[11px] text-[#8E8E93]">
                                      {exercises.length} exercise{exercises.length !== 1 ? "s" : ""}
                                    </span>
                                  </div>
                                  <ul className="space-y-1">
                                    {exercises.map((ex, i) => (
                                      <li
                                        key={i}
                                        className="text-[11px] text-[#E5E5EA]"
                                      >
                                        {ex.name} — {ex.sets}×{ex.reps}{ex.weight ? ` @ ${ex.weight}` : ""}
                                      </li>
                                    ))}
                                    {exercises.length === 0 && (
                                      <li className="text-[11px] text-[#636366]">
                                        No exercises defined for this day.
                                      </li>
                                    )}
                                  </ul>
                                  <button
                                    onClick={() => {
                                      setPreviewRoutine(r);
                                      setPreviewDay(dayName);
                                      setPreviewRun(null);
                                      setTab("preview");
                                    }}
                                    className="mt-3 w-full bg-white text-black rounded-full py-2 text-xs font-semibold soft-glow active:scale-95"
                                  >
                                    View routine
                                  </button>
                                </div>
                              );
                            })}

                            {runForDay && (
                              <div className="bg-[#1C1C1E] soft-border rounded-2xl p-3">
                                <div className="flex justify-between items-center mb-1">
                                  <span className="text-sm font-semibold">{runForDay.name}</span>
                                  <span className="text-[11px] text-[#8E8E93]">
                                    {runForDay.distance ? `${runForDay.distance} km` : "Run"}
                                  </span>
                                </div>
                                <ul className="space-y-1 text-[11px] text-[#E5E5EA]">
                                  {runForDay.pace && (
                                    <li>Target pace: {runForDay.pace}</li>
                                  )}
                                  {runForDay.notes && (
                                    <li>Notes: {runForDay.notes}</li>
                                  )}
                                  {!runForDay.pace && !runForDay.notes && (
                                    <li className="text-[#636366]">No extra details.</li>
                                  )}
                                </ul>
                                <div className="flex gap-2 mt-3">
                                  <button
                                    onClick={() => {
                                      setPreviewRun({ ...runForDay, day: dayName });
                                      setPreviewDay(dayName);
                                      setPreviewRoutine(null);
                                      setTab("previewRun");
                                    }}
                                    className="flex-1 bg-white text-black rounded-full py-2 text-xs font-semibold soft-glow active:scale-95"
                                  >
                                    View run
                                  </button>
                                  <button
                                    onClick={() => deleteRunForDay(dayName)}
                                    className="px-3 py-2 rounded-full text-[11px] text-[#FF453A] border border-[#FF453A]/40"
                                  >
                                    Delete
                                  </button>
                                </div>
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>

              {/* ROUTINES LIST */}
              <div>
                <h2 className="text-lg font-semibold mb-3">All gym routines</h2>

                {Object.keys(routines).length === 0 && (
                  <p className="text-xs text-[#636366]">
                    No routines yet. Tap + to create one.
                  </p>
                )}

                <div className="grid grid-cols-1 gap-4">
                  {Object.values(routines).map(r => (
                    <div
                      key={r.name}
                      className="bg-[#1C1C1E] soft-border rounded-[24px] p-4 text-left"
                    >
                      <div className="flex justify-between items-center mb-1">
                        <h3 className="font-semibold text-base">{r.name}</h3>
                        <button
                          onClick={() => deleteRoutine(r.name)}
                          className="text-[11px] text-[#FF453A]"
                        >
                          Delete
                        </button>
                      </div>
                      <p className="text-[11px] text-[#8E8E93] mb-1">
                        {r.days && r.days.length > 0
                          ? `Days: ${r.days.join(", ")}`
                          : "No days assigned"}
                      </p>
                      <p className="text-[11px] text-[#8E8E93]">
                        Total exercises:{" "}
                        {Object.values(r.workouts || {}).reduce(
                          (sum, arr) => sum + arr.length,
                          0
                        )}
                      </p>
                    </div>
                  ))}
                </div>
              </div>

              {/* RUNNING SUMMARY */}
              <div>
                <h2 className="text-lg font-semibold mb-3">Running plan</h2>
                {Object.keys(runningSessions).length === 0 && (
                  <p className="text-xs text-[#636366]">
                    No runs yet. Create a running session from the + button.
                  </p>
                )}
                <div className="space-y-2">
                  {WEEK_DAYS.map(day => {
                    const run = runningSessions[day];
                    if (!run) return null;
                    return (
                      <div
                        key={day}
                        className="bg-[#1C1C1E] soft-border rounded-2xl p-3 flex justify-between items-center"
                      >
                        <div>
                          <p className="text-xs text-[#8E8E93] uppercase tracking-wide">{day}</p>
                          <p className="text-sm font-semibold">{run.name}</p>
                          <p className="text-[11px] text-[#8E8E93]">
                            {run.distance ? `${run.distance} km` : ""}{run.pace ? ` • ${run.pace}` : ""}
                          </p>
                        </div>
                        <span className="w-2 h-2 rounded-full bg-green-400"></span>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          )}

          {/* CREATE ROUTINE / RUN SCREEN */}
          {tab === "home" && creating && (
            <div className="px-6 space-y-6">

              {/* Type toggle */}
              <div className="flex bg-[#1C1C1E] soft-border rounded-full p-1 text-xs">
                <button
                  onClick={() => {
                    setRoutineType("gym");
                    setSelectedDays([]);
                    setActiveDayTab(null);
                  }}
                  className={`flex-1 py-2 rounded-full ${
                    routineType === "gym" ? "bg-white text-black" : "text-[#8E8E93]"
                  }`}
                >
                  Gym routine
                </button>
                <button
                  onClick={() => {
                    setRoutineType("run");
                    setSelectedDays([]);
                    setActiveDayTab(null);
                  }}
                  className={`flex-1 py-2 rounded-full ${
                    routineType === "run" ? "bg-white text-black" : "text-[#8E8E93]"
                  }`}
                >
                  Running session
                </button>
              </div>

              {/* Name */}
              <div className="space-y-2">
                <label className="text-xs text-[#8E8E93]">
                  {routineType === "gym" ? "Routine name" : "Run name"}
                </label>
                <input
                  value={routineName}
                  onChange={e => setRoutineName(e.target.value)}
                  placeholder={routineType === "gym" ? "e.g. Push Day" : "e.g. 5km Easy Run"}
                  className="w-full bg-[#1C1C1E] soft-border rounded-full px-4 py-3 text-sm text-white placeholder:text-[#636366]"
                />
              </div>

              {/* Day selector */}
              <div className="space-y-2">
                <p className="text-xs text-[#8E8E93]">Days</p>
                <div className="flex flex-wrap gap-2">
                  {WEEK_DAYS.map(d => {
                    const active = selectedDays.includes(d);
                    const hasRunAlready = routineType === "run" && runningSessions[d];
                    return (
                      <button
                        key={d}
                        onClick={() => toggleDaySelection(d)}
                        disabled={hasRunAlready}
                        className={`px-3 py-1.5 rounded-full text-[11px] border transition ${
                          active
                            ? "border-white text-white bg-[#1C1C1E]"
                            : "border-[#3A3A3C] text-[#E5E5EA] bg-[#0C0C0C]"
                        } ${hasRunAlready ? "opacity-40 cursor-not-allowed" : ""}`}
                      >
                        {d}{hasRunAlready && routineType === "run" ? " (run set)" : ""}
                      </button>
                    );
                  })}
                </div>
              </div>

              {/* Gym-specific UI */}
              {routineType === "gym" && (
                <>
                  {/* Day tabs + exercises */}
                  {selectedDays.length > 0 && (
                    <div className="space-y-3">
                      {/* Tabs */}
                      <div className="flex border-b border-[#2C2C2E]">
                        {selectedDays.map(day => {
                          const active = day === activeDayTab;
                          return (
                            <button
                              key={day}
                              onClick={() => setActiveDayTab(day)}
                              className={`mr-4 pb-2 text-xs ${
                                active ? "text-white" : "text-[#8E8E93]"
                              }`}
                            >
                              <div>{day}</div>
                              {active && (
                                <div className="h-0.5 bg-white rounded-full mt-1"></div>
                              )}
                            </button>
                          );
                        })}
                      </div>

                      {/* Exercises for active day */}
                      {activeDayTab && (
                        <div className="space-y-3 mt-2">
                          <p className="text-[11px] text-[#8E8E93]">
                            Exercises for {activeDayTab}
                          </p>
                          <div className="space-y-2">
                            {(dayWorkouts[activeDayTab] || []).length === 0 && (
                              <p className="text-[11px] text-[#636366]">
                                No exercises yet. Tap “Add exercise”.
                              </p>
                            )}
                            {(dayWorkouts[activeDayTab] || []).map((ex, i) => (
                              <div
                                key={i}
                                className="bg-[#1C1C1E] soft-border rounded-2xl p-3"
                              >
                                <p className="font-semibold text-sm">{ex.name}</p>
                                <p className="text-[11px] text-[#8E8E93] mt-1">
                                  {ex.sets} sets • {ex.reps} reps • {ex.weight || "Bodyweight"}
                                </p>
                              </div>
                            ))}
                          </div>

                          <button
                            onClick={openAddExerciseModal}
                            className="w-full bg-white text-black rounded-full py-3 text-sm font-semibold soft-glow active:scale-95"
                          >
                            Add exercise for {activeDayTab}
                          </button>
                        </div>
                      )}
                    </div>
                  )}
                </>
              )}

              {/* Running-specific UI */}
              {routineType === "run" && (
                <div className="space-y-3">
                  <div className="space-y-2">
                    <label className="text-xs text-[#8E8E93]">Distance (km)</label>
                    <input
                      value={runDistance}
                      onChange={e => setRunDistance(e.target.value)}
                      placeholder="e.g. 5"
                      className="w-full bg-[#1C1C1E] soft-border rounded-full px-4 py-3 text-sm text-white placeholder:text-[#636366]"
                    />
                  </div>
                  <div className="space-y-2">
                    <label className="text-xs text-[#8E8E93]">Target pace (optional)</label>
                    <input
                      value={runPace}
                      onChange={e => setRunPace(e.target.value)}
                      placeholder="e.g. 6:00 /km"
                      className="w-full bg-[#1C1C1E] soft-border rounded-full px-4 py-3 text-sm text-white placeholder:text-[#636366]"
                    />
                  </div>
                  <div className="space-y-2">
                    <label className="text-xs text-[#8E8E93]">Notes (optional)</label>
                    <textarea
                      value={runNotes}
                      onChange={e => setRunNotes(e.target.value)}
                      placeholder="Keep HR < 150, easy effort..."
                      className="w-full bg-[#1C1C1E] soft-border rounded-2xl px-4 py-3 text-sm text-white placeholder:text-[#636366] min-h-[80px]"
                    />
                  </div>
                </div>
              )}

              {/* Save / Cancel */}
              <div className="space-y-2 pt-2">
                <button
                  onClick={saveRoutine}
                  className="w-full bg-white text-black rounded-full py-3 font-semibold soft-glow active:scale-95 text-sm"
                >
                  Save {routineType === "gym" ? "routine" : "run"}
                </button>
                <button
                  onClick={() => setCreating(false)}
                  className="w-full text-[#8E8E93] text-xs"
                >
                  Cancel
                </button>
              </div>
            </div>
          )}

          {/* CALENDAR TAB (FULL SCREEN) */}
          {tab === "calendar" && (
            <div className="px-0 space-y-4">
              <div className="px-6">
                <div className="flex justify-between items-center mb-2">
                  <h2 className="text-lg font-semibold">Calendar</h2>
                  {selectedCalendarDate && (
                    <span className="text-xs text-[#8E8E93]">
                      {selectedCalendarDate.toDateString()}
                    </span>
                  )}
                </div>
              </div>

              <div
                className="calendar-scroll soft-border rounded-3xl px-3 py-3 bg-[#0C0C0C] mx-4"
                onScroll={handleCalendarScroll}
                ref={calendarRef}
              >
                {/* Weekday header */}
                <div className="grid grid-cols-7 text-[10px] text-[#8E8E93] mb-2 px-1">
                  {WEEK_DAYS.map(d => (
                    <div key={d} className="text-center uppercase tracking-wide">
                      {d}
                    </div>
                  ))}
                </div>

                {calendarRows.map(row => {
                  if (row.type === "month") {
                    return (
                      <div
                        key={row.key}
                        className="sticky-month py-1 px-1"
                      >
                        <div className="text-xs font-medium text-[#8E8E93]">
                          {row.label}
                        </div>
                      </div>
                    );
                  }

                  return (
                    <div
                      key={row.key}
                      className="grid grid-cols-7 gap-y-2 text-sm py-1 px-1"
                    >
                      {row.days.map((date, idx) => {
                        const weekdayIndex = date.getDay();
                        const weekdayName = WEEK_DAYS[weekdayIndex === 0 ? 6 : weekdayIndex - 1];
                        const dotType = getDotColorForDate(date);
                        const hasDot = !!dotType;
                        const isTodayFlag = isSameDay(date, today);
                        const isSelected =
                          selectedCalendarDate && isSameDay(date, selectedCalendarDate);

                        let textColor = "#FFFFFF";
                        if (!isTodayFlag && !isSelected) {
                          textColor = "#E5E5EA";
                        }

                        const dotClass =
                          dotType === "gym" ? "bg-white" :
                          dotType === "run" ? "bg-green-400" :
                          dotType === "both" ? "bg-blue-400" :
                          "";

                        return (
                          <button
                            key={idx}
                            onClick={() => openDayFromCalendar(date)}
                            className="flex flex-col items-center justify-center py-1"
                          >
                            <div
                              className={`w-7 h-7 flex items-center justify-center rounded-full text-xs ${
                                isTodayFlag
                                  ? "bg-[#FF3B30] text-white"
                                  : isSelected
                                  ? "bg-white text-black"
                                  : ""
                              }`}
                              style={{ color: textColor }}
                            >
                              {date.getDate()}
                            </div>
                            {hasDot && (
                              <div className={`w-1.5 h-1.5 rounded-full mt-1 ${dotClass}`}></div>
                            )}
                          </button>
                        );
                      })}
                    </div>
                  );
                })}
              </div>

              {/* Routines / Run for selected date */}
              <div className="px-6 pb-4">
                {selectedCalendarDate && (
                  <div className="space-y-2">
                    <p className="text-xs text-[#8E8E93]">
                      {selectedCalendarDate.toLocaleDateString(undefined, {
                        weekday: "long",
                        month: "short",
                        day: "numeric"
                      })}
                    </p>
                    {dayRoutines.length === 0 && !dayRun && (
                      <p className="text-xs text-[#636366]">
                        No routines or runs scheduled for this day.
                      </p>
                    )}
                    {dayRoutines.map(r => (
                      <button
                        key={r.name}
                        onClick={() => openPreviewFromDate(r, selectedCalendarDate)}
                        className="w-full bg-[#1C1C1E] soft-border rounded-2xl p-3 text-left text-sm active:scale-95 transition"
                      >
                        <div className="flex justify-between items-center">
                          <span className="font-semibold">{r.name}</span>
                          <span className="text-[#8E8E93] text-xs">
                            {(() => {
                              const d = selectedCalendarDate;
                              const weekdayIndex = d.getDay();
                              const weekdayName = WEEK_DAYS[weekdayIndex === 0 ? 6 : weekdayIndex - 1];
                              return r.workouts[weekdayName]?.length || 0;
                            })()}{" "}
                            exercises
                          </span>
                        </div>
                      </button>
                    ))}
                    {dayRun && (
                      <button
                        onClick={() => openRunPreviewFromDate(dayRun, selectedCalendarDate)}
                        className="w-full bg-[#1C1C1E] soft-border rounded-2xl p-3 text-left text-sm active:scale-95 transition"
                      >
                        <div className="flex justify-between items-center">
                          <span className="font-semibold">{dayRun.name}</span>
                          <span className="text-[#8E8E93] text-xs">
                            {dayRun.distance ? `${dayRun.distance} km` : "Run"}
                          </span>
                        </div>
                      </button>
                    )}
                  </div>
                )}
              </div>
            </div>
          )}

          {/* WORKOUT SCREEN */}
          {tab === "workout" && workoutRoutine && (
            <div className="px-6 space-y-6">

              <div className="flex justify-between text-xs text-[#8E8E93] mt-2">
                <button
                  onClick={() => {
                    setTab("home");
                    setWorkoutRoutine(null);
                    setRunning(false);
                  }}
                >
                  ← Back
                </button>
                <button
                  className="text-[#FF453A]"
                  onClick={() => {
                    setRunning(false);
                    setWorkoutRoutine(null);
                    setTab("home");
                  }}
                >
                  Finish
                </button>
              </div>

              <div className="text-center">
                <div className="text-5xl font-mono mb-2">{formatTime(timer)}</div>
                <button
                  onClick={() => setRunning(r => !r)}
                  className="px-6 py-3 bg-white text-black rounded-full font-semibold soft-glow active:scale-95 text-sm"
                >
                  {running ? "Pause" : "Start"}
                </button>
              </div>

              <div>
                <h2 className="text-lg font-semibold mb-3">
                  {workoutRoutine.name} — {workoutRoutine.day}
                </h2>
                <ul className="space-y-3">
                  {workoutRoutine.exercises.length === 0 && (
                    <p className="text-[11px] text-[#636366]">
                      No exercises defined for this day.
                    </p>
                  )}
                  {workoutRoutine.exercises.map((ex, i) => (
                    <li
                      key={i}
                      className="bg-[#1C1C1E] soft-border rounded-2xl p-4 text-sm"
                    >
                      <p className="font-semibold text-base">{ex.name}</p>
                      <p className="text-[11px] text-[#8E8E93] mt-1">
                        {ex.sets} sets • {ex.reps} reps • {ex.weight || "Bodyweight"}
                      </p>
                    </li>
                  ))}
                </ul>
              </div>
            </div>
          )}

          {/* RUN SCREEN */}
          {tab === "run" && runSession && (
            <div className="px-6 space-y-6">

              <div className="flex justify-between text-xs text-[#8E8E93] mt-2">
                <button
                  onClick={() => {
                    setTab("home");
                    setRunSession(null);
                    setRunning(false);
                  }}
                >
                  ← Back
                </button>
                <button
                  className="text-[#FF453A]"
                  onClick={() => {
                    setRunning(false);
                    setRunSession(null);
                    setTab("home");
                  }}
                >
                  Finish
                </button>
              </div>

              <div className="text-center">
                <div className="text-5xl font-mono mb-2">{formatTime(timer)}</div>
                <button
                  onClick={() => setRunning(r => !r)}
                  className="px-6 py-3 bg-white text-black rounded-full font-semibold soft-glow active:scale-95 text-sm"
                >
                  {running ? "Pause" : "Start"}
                </button>
              </div>

              <div className="space-y-3">
                <h2 className="text-lg font-semibold mb-1">
                  {runSession.name} — {runSession.day}
                </h2>
                <p className="text-sm text-[#E5E5EA]">
                  {runSession.distance ? `${runSession.distance} km` : ""}
                  {runSession.pace ? ` • ${runSession.pace}` : ""}
                </p>
                {runSession.notes && (
                  <p className="text-xs text-[#8E8E93] mt-1">
                    {runSession.notes}
                  </p>
                )}
              </div>
            </div>
          )}

          {/* PREVIEW SCREEN (GYM) */}
          {tab === "preview" && previewRoutine && (
            <div className="px-6 pt-4 pb-10 space-y-6">
              <div className="flex items-center justify-between text-xs text-[#8E8E93] mb-2">
                <button
                  onClick={() => {
                    setTab("home");
                    setPreviewRoutine(null);
                    setPreviewDay(null);
                  }}
                  className="text-white"
                >
                  ← Back
                </button>
              </div>

              <div>
                <h2 className="text-2xl font-semibold mb-1">
                  {previewRoutine.name}
                </h2>
                {previewDay && (
                  <p className="text-xs text-[#8E8E93] mb-3">
                    {previewDay}
                  </p>
                )}
              </div>

              <div>
                <h3 className="text-sm font-semibold mb-2">Exercises</h3>
                <ul className="space-y-3">
                  {(() => {
                    const exercises = (previewRoutine.workouts && previewRoutine.workouts[previewDay]) || [];
                    if (exercises.length === 0) {
                      return (
                        <p className="text-[11px] text-[#636366]">
                          No exercises defined for this day.
                        </p>
                      );
                    }
                    return exercises.map((ex, i) => (
                      <li
                        key={i}
                        className="bg-[#1C1C1E] soft-border rounded-2xl p-4 text-sm"
                      >
                        <p className="font-semibold text-base">{ex.name}</p>
                        <p className="text-[11px] text-[#8E8E93] mt-1">
                          {ex.sets} sets • {ex.reps} reps • {ex.weight || "Bodyweight"}
                        </p>
                      </li>
                    ));
                  })()}
                </ul>
              </div>

              <div className="pt-4">
                <button
                  onClick={startWorkoutFromPreview}
                  className="w-full bg-white text-black rounded-full py-3 font-semibold soft-glow active:scale-95 text-sm"
                >
                  Start workout
                </button>
              </div>
            </div>
          )}

          {/* PREVIEW SCREEN (RUN) */}
          {tab === "previewRun" && previewRun && (
            <div className="px-6 pt-4 pb-10 space-y-6">
              <div className="flex items-center justify-between text-xs text-[#8E8E93] mb-2">
                <button
                  onClick={() => {
                    setTab("home");
                    setPreviewRun(null);
                    setPreviewDay(null);
                  }}
                  className="text-white"
                >
                  ← Back
                </button>
              </div>

              <div>
                <h2 className="text-2xl font-semibold mb-1">
                  {previewRun.name}
                </h2>
                {previewDay && (
                  <p className="text-xs text-[#8E8E93] mb-3">
                    {previewDay}
                  </p>
                )}
              </div>

              <div className="space-y-2 text-sm">
                {previewRun.distance && (
                  <p>Distance: {previewRun.distance} km</p>
                )}
                {previewRun.pace && (
                  <p>Target pace: {previewRun.pace}</p>
                )}
                {previewRun.notes && (
                  <p className="text-xs text-[#8E8E93]">
                    Notes: {previewRun.notes}
                  </p>
                )}
                {!previewRun.distance && !previewRun.pace && !previewRun.notes && (
                  <p className="text-[11px] text-[#636366]">
                    No extra details for this run.
                  </p>
                )}
              </div>

              <div className="pt-4">
                <button
                  onClick={startRunFromPreview}
                  className="w-full bg-white text-black rounded-full py-3 font-semibold soft-glow active:scale-95 text-sm"
                >
                  Start run
                </button>
              </div>
            </div>
          )}

          {/* SLIDE-UP MODAL FOR ADDING EXERCISE */}
          {showModal && (
            <div className="fixed inset-0 bg-black/60 flex items-end justify-center">
              <div className="w-full max-w-md bg-[#1C1C1E] soft-border rounded-t-[32px] p-6 modal-slide">
                <h2 className="text-lg font-semibold mb-4">
                  Add exercise — {activeDayTab}
                </h2>

                <div className="space-y-3">
                  <input
                    placeholder="Exercise name"
                    value={exerciseForm.name}
                    onChange={e => setExerciseForm({ ...exerciseForm, name: e.target.value })}
                    className="w-full bg-black rounded-full px-4 py-3 soft-border text-sm placeholder:text-[#636366]"
                  />

                  <input
                    placeholder="Sets"
                    type="number"
                    value={exerciseForm.sets}
                    onChange={e => setExerciseForm({ ...exerciseForm, sets: e.target.value })}
                    className="w-full bg-black rounded-full px-4 py-3 soft-border text-sm placeholder:text-[#636366]"
                  />

                  <input
                    placeholder="Reps"
                    type="number"
                    value={exerciseForm.reps}
                    onChange={e => setExerciseForm({ ...exerciseForm, reps: e.target.value })}
                    className="w-full bg-black rounded-full px-4 py-3 soft-border text-sm placeholder:text-[#636366]"
                  />

                  <input
                    placeholder="Weight (optional)"
                    value={exerciseForm.weight}
                    onChange={e => setExerciseForm({ ...exerciseForm, weight: e.target.value })}
                    className="w-full bg-black rounded-full px-4 py-3 soft-border text-sm placeholder:text-[#636366]"
                  />
                </div>

                <button
                  onClick={addExerciseToDay}
                  className="w-full bg-white text-black rounded-full py-3 font-semibold soft-glow mt-6 active:scale-95 text-sm"
                >
                  Add exercise
                </button>

                <button
                  onClick={() => setShowModal(false)}
                  className="w-full text-[#8E8E93] text-xs mt-3"
                >
                  Cancel
                </button>
              </div>
            </div>
          )}

          {/* FLOATING + BUTTON */}
          {tab === "home" && !creating && (
            <button
              onClick={startCreateRoutine}
              className="fixed bottom-24 right-6 w-14 h-14 bg-white text-black rounded-full text-3xl flex items-center justify-center soft-glow active:scale-95"
            >
              +
            </button>
          )}

          {/* NAVIGATION BAR (HIDDEN ON PREVIEW SCREENS) */}
          {tab !== "preview" && tab !== "previewRun" && (
            <div className="fixed bottom-4 left-0 right-0 max-w-md mx-auto px-6">
              <div className="glass-nav soft-border rounded-[24px] py-2.5">
                <div className="grid grid-cols-3 text-center text-xs">
                  {[
                    ["home", "Home", "🏠"],
                    ["calendar", "Calendar", "📅"],
                    ["workout", "Workout", "💪"]
                  ].map(([key, label, icon], idx) => (
                    <button
                      key={idx}
                      onClick={() => setTab(key)}
                      className={`flex flex-col items-center gap-0.5 transition ${
                        tab === key ? "text-white" : "text-[#8E8E93]"
                      }`}
                    >
                      <span className="text-lg">{icon}</span>
                      <span>{label}</span>
                    </button>
                  ))}
                </div>
              </div>
            </div>
          )}

        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
